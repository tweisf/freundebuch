<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#0f172a;color:#f8fafc}
  main{max-width:900px;margin:auto;padding:20px}
  .hero{display:flex;align-items:center;gap:14px;margin-bottom:14px}
  .icon{width:52px;height:52px;border-radius:16px;background:rgba(148,163,184,.15);display:flex;align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.25)}
  .title{font-size:42px;font-weight:900;margin:0}
  .sub{color:#cbd5e1;margin:0}
  .card{
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.25);
    border-radius:22px;
    padding:16px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  label{display:block;font-size:13px;color:#94a3b8;margin-top:10px}
  input,button{
    width:100%;padding:12px;border-radius:14px;border:1px solid rgba(148,163,184,.25);
    background:rgba(15,23,42,.35);color:#f8fafc;margin-top:6px
  }
  button{cursor:pointer;font-weight:800}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{flex:1;min-width:180px;background:rgba(148,163,184,.12)}
  .btnPrimary{background:linear-gradient(135deg,#60a5fa,#34d399);border:none}
  .btnDanger{background:linear-gradient(135deg,#fb7185,#f97316);border:none}
  .muted{color:#94a3b8;margin-top:10px}
  .status{margin-top:10px;font-weight:800}
  .ok{color:#34d399}
  .err{color:#fb7185}

  .list{margin-top:14px}
  .entry{
    border:1px solid rgba(148,163,184,.22);
    border-radius:18px;
    padding:12px;
    margin-top:12px;
    background:rgba(2,6,23,.35)
  }
  .row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{font-size:12px;color:#cbd5e1;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.22);background:rgba(148,163,184,.08)}
  .name{font-weight:900;font-size:18px;margin:0}
  .meta{color:#94a3b8;font-size:13px;margin-top:2px}
  .q{color:#94a3b8;font-size:12px;margin-top:10px}
  .a{margin-top:3px;white-space:pre-wrap}
  img{width:100%;max-width:360px;border-radius:14px;margin-top:10px;border:1px solid rgba(148,163,184,.18)}

  /* Home Button unten rechts */
  .homeBtn{
    position:fixed;right:14px;bottom:14px;
    width:56px;height:56px;border-radius:18px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(2,6,23,.45);
    color:#f8fafc;text-decoration:none;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .homeBtn:active{transform:scale(.98)}
</style>
</head>

<body>
<main>
  <div class="hero">
    <div class="icon">üîí</div>
    <div>
      <h1 class="title">Admin</h1>
      <p class="sub">Login + Eintr√§ge verwalten (l√∂schen nur Admin).</p>
    </div>
  </div>

  <div class="card">
    <label>E-Mail</label>
    <!-- WICHTIG: NICHT vorausgef√ºllt -->
    <input id="email" type="email" placeholder="E-Mail eingeben" autocomplete="username" />

    <label>Passwort</label>
    <input id="pass" type="password" placeholder="Passwort" autocomplete="current-password" />

    <div class="btnRow">
      <button class="btn btnPrimary" id="loginBtn">Einloggen</button>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>

    <div class="muted" id="who">Nicht eingeloggt.</div>
    <div class="status" id="status"></div>

    <hr style="border:none;border-top:1px solid rgba(148,163,184,.18);margin:14px 0">

    <div class="btnRow">
      <button class="btn" id="loadFreund">üìó Freundebuch laden</button>
      <button class="btn" id="loadGast">üìù G√§stebuch laden</button>
    </div>

    <div class="list" id="list"></div>
  </div>
</main>

<a class="homeBtn" href="index.html" title="Zur Startseite">üè†</a>

<script>
  // ========= Firebase =========
  const firebaseConfig = {
    apiKey: "AIzaSyCLnz3t9VcQJLg2oqbZd2cA7-hXF30UyHM",
    authDomain: "freundebuch-neu.firebaseapp.com",
    projectId: "freundebuch-neu",
    storageBucket: "freundebuch-neu.firebasestorage.app",
    messagingSenderId: "732597691942",
    appId: "1:732597691942:web:2c116f530c4179d1c2a8e7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();
  const auth = firebase.auth();

  const ADMIN_EMAIL = "male01.w@gmail.com";

  const el = (id) => document.getElementById(id);
  const statusEl = el("status");
  const whoEl = el("who");
  const listEl = el("list");

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function setStatus(msg, type){
    statusEl.className = "status " + (type || "");
    statusEl.textContent = msg || "";
  }

  function isAdmin(user){
    return !!user && (user.email || "").toLowerCase() === ADMIN_EMAIL.toLowerCase();
  }

  function formatDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : new Date();
      return d.toLocaleString("de-DE");
    }catch{ return ""; }
  }

  // --- Auth State ---
  auth.onAuthStateChanged((user) => {
    if(user){
      whoEl.textContent = "Eingeloggt: " + user.email + (isAdmin(user) ? " (Admin)" : " (kein Admin)");
      setStatus(isAdmin(user) ? "‚úÖ Admin aktiv." : "‚ö†Ô∏è Du bist nicht als Admin eingeloggt.", isAdmin(user) ? "ok" : "err");
    } else {
      whoEl.textContent = "Nicht eingeloggt.";
      setStatus("", "");
    }
  });

  // --- Login ---
  el("loginBtn").addEventListener("click", async () => {
    const email = el("email").value.trim();
    const pass = el("pass").value;

    if(!email || !pass){
      setStatus("‚ùå Bitte E-Mail + Passwort eingeben.", "err");
      return;
    }

    setStatus("‚è≥ Login‚Ä¶", "");
    try{
      const cred = await auth.signInWithEmailAndPassword(email, pass);
      if(!isAdmin(cred.user)){
        setStatus("‚ùå Eingeloggt, aber nicht Admin. Logout und mit Admin-Mail einloggen.", "err");
      } else {
        setStatus("‚úÖ Eingeloggt.", "ok");
      }
    }catch(e){
      setStatus("‚ùå Login-Fehler: " + (e?.message || e), "err");
    }
  });

  // --- Logout ---
  el("logoutBtn").addEventListener("click", async () => {
    try{
      await auth.signOut();
      setStatus("‚úÖ Ausgeloggt.", "ok");
      listEl.innerHTML = "";
    }catch(e){
      setStatus("‚ùå Logout-Fehler: " + (e?.message || e), "err");
    }
  });

  // ========= Laden & Render =========
  async function loadType(type){
    setStatus("‚è≥ Lade " + type + "‚Ä¶", "");
    listEl.innerHTML = "‚è≥ Lade‚Ä¶";

    try{
      // Index-frei: nur orderBy, danach filtern
      const snap = await db.collection("entries")
        .orderBy("created","desc")
        .limit(200)
        .get();

      const items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
        .filter(d => d.type === type);

      if(!items.length){
        listEl.innerHTML = "<div class='muted'>Noch keine Eintr√§ge.</div>";
        setStatus("‚úÖ Keine Eintr√§ge gefunden.", "ok");
        return;
      }

      listEl.innerHTML = items.map(d => renderEntry(d)).join("");
      setStatus("‚úÖ Geladen: " + items.length + " Eintr√§ge.", "ok");

    }catch(e){
      listEl.innerHTML = "";
      setStatus("‚ùå Fehler beim Laden: " + (e?.message || e), "err");
    }
  }

  function renderEntry(d){
    const a = d.answers || {};
    const name = a.name || a.fb_name || a.gb_name || "Unbekannt";
    const time = formatDate(d.created);

    // Ein paar Keys sch√∂n anzeigen (aber vollst√§ndig bleibt in den anderen Seiten)
    const preview = Object.entries(a).slice(0, 6).map(([k,v]) =>
      `<div class="q">${esc(k)}</div><div class="a">${esc(v)}</div>`
    ).join("");

    return `
      <div class="entry" data-id="${esc(d.id)}">
        <div class="row">
          <div>
            <p class="name">${esc(name)}</p>
            <div class="meta">${esc(time)} ‚Ä¢ <span class="pill">${esc(d.type)}</span></div>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn btnDanger" onclick="deleteEntry('${esc(d.id)}')" style="min-width:160px">üóëÔ∏è L√∂schen</button>
          </div>
        </div>

        ${d.imageUrl ? `<img src="${esc(d.imageUrl)}" alt="Foto">` : ""}

        ${preview}
      </div>
    `;
  }

  // ========= L√∂schen (nur Admin) =========
  async function deleteEntry(docId){
    const user = auth.currentUser;
    if(!isAdmin(user)){
      setStatus("‚ùå L√∂schen nur als Admin.", "err");
      return;
    }

    if(!confirm("Wirklich l√∂schen? (Dokument + ggf. Bild)")){
      return;
    }

    setStatus("‚è≥ L√∂sche‚Ä¶", "");

    try{
      // 1) Dokument lesen (f√ºr imageUrl)
      const ref = db.collection("entries").doc(docId);
      const snap = await ref.get();
      if(!snap.exists){
        setStatus("‚ö†Ô∏è Eintrag existiert nicht mehr.", "err");
        return;
      }

      const data = snap.data() || {};
      const imageUrl = data.imageUrl || "";

      // 2) Bild l√∂schen (wenn vorhanden)
      if(imageUrl){
        try{
          const storageRef = storage.refFromURL(imageUrl);
          await storageRef.delete();
        }catch(imgErr){
          // Falls z.B. schon gel√∂scht: nicht hart abbrechen
          console.warn("Bild l√∂schen fehlgeschlagen:", imgErr);
        }
      }

      // 3) Firestore Doc l√∂schen
      await ref.delete();

      // 4) UI entfernen
      const node = document.querySelector(`.entry[data-id="${CSS.escape(docId)}"]`);
      if(node) node.remove();

      setStatus("‚úÖ Gel√∂scht.", "ok");
    }catch(e){
      setStatus("‚ùå L√∂schen fehlgeschlagen: " + (e?.message || e), "err");
    }
  }

  // Buttons zum Laden
  el("loadFreund").addEventListener("click", () => loadType("freundebuch"));
  el("loadGast").addEventListener("click", () => loadType("gaestebuch"));

  // Global f√ºr onclick
  window.deleteEntry = deleteEntry;

  // Optional: beim √ñffnen noch nichts laden (du l√§dst bewusst √ºber Buttons)
</script>
</body>
</html>