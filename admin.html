<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#0f172a;color:#f8fafc}
  main{max-width:900px;margin:auto;padding:20px}
  .hero{display:flex;align-items:center;gap:14px;margin-bottom:14px}
  .icon{width:52px;height:52px;border-radius:16px;background:rgba(148,163,184,.15);display:flex;align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.25)}
  .title{font-size:42px;font-weight:900;margin:0}
  .sub{color:#cbd5e1;margin:0}
  .card{
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.25);
    border-radius:22px;
    padding:16px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  label{display:block;font-size:13px;color:#94a3b8;margin-top:10px}
  input,button{
    width:100%;padding:12px;border-radius:14px;border:1px solid rgba(148,163,184,.25);
    background:rgba(15,23,42,.35);color:#f8fafc;margin-top:6px
  }
  button{cursor:pointer;font-weight:800}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{flex:1;min-width:180px;background:rgba(148,163,184,.12)}
  .btnPrimary{background:linear-gradient(135deg,#60a5fa,#34d399);border:none}
  .btnDanger{background:linear-gradient(135deg,#fb7185,#f97316);border:none}
  .muted{color:#94a3b8;margin-top:10px}
  .status{margin-top:10px;font-weight:800}
  .ok{color:#34d399}
  .err{color:#fb7185}

  .list{margin-top:14px}
  .entry{
    border:1px solid rgba(148,163,184,.22);
    border-radius:18px;
    padding:12px;
    margin-top:12px;
    background:rgba(2,6,23,.35)
  }
  .row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{font-size:12px;color:#cbd5e1;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.22);background:rgba(148,163,184,.08)}
  .name{font-weight:900;font-size:18px;margin:0}
  .meta{color:#94a3b8;font-size:13px;margin-top:2px}
  .q{color:#94a3b8;font-size:12px;margin-top:10px}
  .a{margin-top:3px;white-space:pre-wrap}
  img{width:100%;max-width:360px;border-radius:14px;margin-top:10px;border:1px solid rgba(148,163,184,.18)}

  /* Home Button unten rechts */
  .homeBtn{
    position:fixed;right:14px;bottom:14px;
    width:56px;height:56px;border-radius:18px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(2,6,23,.45);
    color:#f8fafc;text-decoration:none;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index:1000;
  }
  .homeBtn:active{transform:scale(.98)}

  /* ===== Diashow Admin ===== */
  .sectionTitle{font-weight:900;font-size:16px;margin:0}
  .sectionSub{color:#94a3b8;font-size:13px;margin:6px 0 0}
  hr.soft{border:none;border-top:1px solid rgba(148,163,184,.18);margin:14px 0}

  .heroGrid{display:grid;gap:12px}
  @media (min-width:820px){ .heroGrid{grid-template-columns: 1.1fr .9fr} }

  .thumbGrid{display:grid;gap:10px;grid-template-columns:1fr}
  @media (min-width:720px){ .thumbGrid{grid-template-columns: 1fr 1fr} }

  .thumb{
    border:1px solid rgba(148,163,184,.22);
    border-radius:16px;
    overflow:hidden;
    background:rgba(2,6,23,.35);
    padding:10px;
  }
  .thumb img{
    width:100%;display:block;border-radius:12px;border:1px solid rgba(148,163,184,.18);
    aspect-ratio: 16/9; object-fit: cover;
  }
  .thumbMeta{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-top:10px}
  .thumbName{font-weight:900}
  .mini{font-size:12px;color:#94a3b8}
  .miniBtn{
    width:auto;margin:0;
    padding:8px 10px;border-radius:12px;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(148,163,184,.10);
    color:#f8fafc;
    cursor:pointer;
    font-weight:900;
  }
  .miniBtn:hover{border-color:rgba(148,163,184,.35)}
</style>
</head>

<body>
<main>
  <div class="hero">
    <div class="icon">üîí</div>
    <div>
      <h1 class="title">Admin</h1>
      <p class="sub">Login + Eintr√§ge verwalten (l√∂schen nur Admin).</p>
    </div>
  </div>

  <div class="card">
    <label>E-Mail</label>
    <input id="email" type="email" placeholder="E-Mail eingeben" autocomplete="username" />

    <label>Passwort</label>
    <input id="pass" type="password" placeholder="Passwort" autocomplete="current-password" />

    <div class="btnRow">
      <button class="btn btnPrimary" id="loginBtn">Einloggen</button>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>

    <!-- ‚úÖ Notfall-Logout (nur Admin) -->
    <div class="btnRow">
      <button class="btn btnDanger" id="panicLogoutBtn">üö® Admin-Notfall-Logout</button>
    </div>

    <div class="muted" id="who">Nicht eingeloggt.</div>
    <div class="status" id="status"></div>

    <hr class="soft">

    <!-- ‚úÖ NEU: Startseiten-Diashow Admin -->
    <div id="heroAdmin" style="display:none;">
      <div class="heroGrid">
        <div>
          <p class="sectionTitle">üñºÔ∏è Startseiten-Diashow</p>
          <p class="sectionSub">
            Bilder werden auf der Startseite automatisch alle 30s gewechselt.
            Hier kannst du Bilder hinzuf√ºgen oder entfernen.
          </p>

          <label>Bild ausw√§hlen (JPG/PNG)</label>
          <input id="heroFile" type="file" accept="image/*" />

          <label>Name (optional)</label>
          <input id="heroName" type="text" placeholder="z.B. Urlaub 2024" />

          <div class="btnRow">
            <button class="btn btnPrimary" id="heroUploadBtn">‚¨ÜÔ∏è Bild hochladen</button>
            <button class="btn" id="heroReloadBtn">üîÑ Liste neu laden</button>
          </div>

          <div class="muted" id="heroInfo"></div>
        </div>

        <div>
          <p class="sectionTitle">üìå Hinweis</p>
          <p class="sectionSub">
            Die Bilder werden gespeichert in Firebase Storage unter <b>/hero/</b>
            und als Eintr√§ge in Firestore unter
            <b>site/heroImages/items</b>.
          </p>
        </div>
      </div>

      <div class="list" id="heroList"></div>

      <hr class="soft">
    </div>

    <div class="btnRow">
      <button class="btn" id="loadFreund">üìó Freundebuch laden</button>
      <button class="btn" id="loadGast">üìù G√§stebuch laden</button>
    </div>

    <div class="list" id="list"></div>
  </div>
</main>

<a class="homeBtn" href="index.html" title="Zur Startseite">üè†</a>

<script>
  // ========= Firebase =========
  const firebaseConfig = {
    apiKey: "AIzaSyCLnz3t9VcQJLg2oqbZd2cA7-hXF30UyHM",
    authDomain: "freundebuch-neu.firebaseapp.com",
    projectId: "freundebuch-neu",
    storageBucket: "freundebuch-neu.firebasestorage.app",
    messagingSenderId: "732597691942",
    appId: "1:732597691942:web:2c116f530c4179d1c2a8e7"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();
  const auth = firebase.auth();

  const ADMIN_EMAIL = "male01.w@gmail.com";

  const el = (id) => document.getElementById(id);
  const statusEl = el("status");
  const whoEl = el("who");
  const listEl = el("list");

  // Slideshow Admin
  const heroAdminEl = el("heroAdmin");
  const heroFileEl = el("heroFile");
  const heroNameEl = el("heroName");
  const heroUploadBtn = el("heroUploadBtn");
  const heroReloadBtn = el("heroReloadBtn");
  const heroInfoEl = el("heroInfo");
  const heroListEl = el("heroList");

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function setStatus(msg, type){
    statusEl.className = "status " + (type || "");
    statusEl.textContent = msg || "";
  }

  function isAdmin(user){
    return !!user && (user.email || "").toLowerCase() === ADMIN_EMAIL.toLowerCase();
  }

  function formatDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : new Date();
      return d.toLocaleString("de-DE");
    }catch{ return ""; }
  }

  // --- Auth State ---
  auth.onAuthStateChanged((user) => {
    if(user){
      whoEl.textContent = "Eingeloggt: " + user.email + (isAdmin(user) ? " (Admin)" : " (kein Admin)");
      setStatus(isAdmin(user) ? "‚úÖ Admin aktiv." : "‚ö†Ô∏è Du bist nicht als Admin eingeloggt.", isAdmin(user) ? "ok" : "err");

      // Slideshow Admin sichtbar nur f√ºr Admin
      if (isAdmin(user)) {
        heroAdminEl.style.display = "block";
        loadHeroImages();
      } else {
        heroAdminEl.style.display = "none";
      }
    } else {
      whoEl.textContent = "Nicht eingeloggt.";
      setStatus("", "");
      heroAdminEl.style.display = "none";
    }
  });

  // --- Login ---
  el("loginBtn").addEventListener("click", async () => {
    const email = el("email").value.trim();
    const pass = el("pass").value;

    if(!email || !pass){
      setStatus("‚ùå Bitte E-Mail + Passwort eingeben.", "err");
      return;
    }

    setStatus("‚è≥ Login‚Ä¶", "");
    try{
      const cred = await auth.signInWithEmailAndPassword(email, pass);
      if(!isAdmin(cred.user)){
        setStatus("‚ùå Eingeloggt, aber nicht Admin. Logout und mit Admin-Mail einloggen.", "err");
      } else {
        setStatus("‚úÖ Eingeloggt.", "ok");
      }
    }catch(e){
      setStatus("‚ùå Login-Fehler: " + (e?.message || e), "err");
    }
  });

  // --- Logout ---
  el("logoutBtn").addEventListener("click", async () => {
    try{
      await auth.signOut();
      setStatus("‚úÖ Ausgeloggt.", "ok");
      listEl.innerHTML = "";
      heroListEl.innerHTML = "";
      heroInfoEl.textContent = "";
    }catch(e){
      setStatus("‚ùå Logout-Fehler: " + (e?.message || e), "err");
    }
  });

  // ========= Admin-Notfall-Logout (nur Admin) =========
  const SESSION_KEY = "fb_pass_ok_at";       // 1h Besucher-Passwort-Session
  const ADMIN_KILL_KEY = "fb_admin_kill_at"; // Signal an andere Tabs

  async function adminEmergencyLogout(){
    const user = auth.currentUser;
    if(!isAdmin(user)){
      alert("‚ùå Nur Admin darf den Notfall-Logout ausl√∂sen.");
      return;
    }

    try{
      await auth.signOut();
    }catch(e){}

    try{ localStorage.removeItem(SESSION_KEY); }catch(e){}
    try{ localStorage.setItem(ADMIN_KILL_KEY, String(Date.now())); }catch(e){}

    location.replace("index.html");
  }

  el("panicLogoutBtn").addEventListener("click", () => {
    if(confirm("Admin sofort ausloggen und Passwort-Session l√∂schen?")){
      adminEmergencyLogout();
    }
  });

  // ========= Startseiten-Diashow Admin =========
  function setHeroInfo(msg){ heroInfoEl.textContent = msg || ""; }

  async function loadHeroImages(){
    if(!isAdmin(auth.currentUser)) return;

    heroListEl.innerHTML = "‚è≥ Lade Bilder‚Ä¶";
    setHeroInfo("");

    try{
      const snap = await db.collection("site")
        .doc("heroImages")
        .collection("items")
        .orderBy("created", "desc")
        .limit(50)
        .get();

      const items = snap.docs.map(d => ({ id: d.id, ...(d.data() || {}) }))
        .filter(x => x.url);

      if(!items.length){
        heroListEl.innerHTML = "<div class='muted'>Noch keine Bilder. Lade das erste hoch üôÇ</div>";
        setHeroInfo("0 Bilder.");
        return;
      }

      setHeroInfo(items.length + " Bilder.");
      heroListEl.innerHTML = `
        <div class="thumbGrid">
          ${items.map(renderHeroThumb).join("")}
        </div>
      `;
    }catch(e){
      heroListEl.innerHTML = "";
      setHeroInfo("‚ùå Fehler beim Laden: " + (e?.message || e));
    }
  }

  function renderHeroThumb(x){
    const name = x.name || "Bild";
    const created = x.created?.toDate ? x.created.toDate().toLocaleString("de-DE") : "";
    return `
      <div class="thumb" data-hero-id="${esc(x.id)}">
        <img src="${esc(x.url)}" alt="${esc(name)}">
        <div class="thumbMeta">
          <div>
            <div class="thumbName">${esc(name)}</div>
            <div class="mini">${esc(created)}</div>
          </div>
          <button class="miniBtn" onclick="deleteHeroImage('${esc(x.id)}')">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }

  async function uploadHeroImage(){
    const user = auth.currentUser;
    if(!isAdmin(user)){
      setHeroInfo("‚ùå Nur Admin.");
      return;
    }

    const file = heroFileEl.files[0];
    if(!file){
      setHeroInfo("‚ùå Bitte zuerst ein Bild ausw√§hlen.");
      return;
    }

    heroUploadBtn.disabled = true;
    setHeroInfo("‚è≥ Upload l√§uft‚Ä¶");

    try{
      const safeName = (file.name || "bild").replace(/\s+/g, "_");
      const stamp = Date.now();
      const path = "hero/" + stamp + "_" + safeName;

      // 1) Storage upload
      const ref = storage.ref(path);
      await ref.put(file);
      const url = await ref.getDownloadURL();

      // 2) Firestore doc
      const name = (heroNameEl.value || "").trim() || safeName;
      await db.collection("site").doc("heroImages").collection("items").add({
        url,
        storagePath: path,
        name,
        created: firebase.firestore.FieldValue.serverTimestamp()
      });

      // reset
      heroFileEl.value = "";
      heroNameEl.value = "";

      setHeroInfo("‚úÖ Hochgeladen!");
      await loadHeroImages();
    }catch(e){
      setHeroInfo("‚ùå Upload-Fehler: " + (e?.message || e));
    }finally{
      heroUploadBtn.disabled = false;
    }
  }

  async function deleteHeroImage(id){
    const user = auth.currentUser;
    if(!isAdmin(user)){
      alert("Nur Admin.");
      return;
    }
    if(!confirm("Bild wirklich l√∂schen?")) return;

    setHeroInfo("‚è≥ L√∂sche‚Ä¶");

    try{
      const docRef = db.collection("site").doc("heroImages").collection("items").doc(id);
      const snap = await docRef.get();
      if(!snap.exists){
        setHeroInfo("‚ö†Ô∏è Bild existiert nicht mehr.");
        await loadHeroImages();
        return;
      }

      const data = snap.data() || {};
      const storagePath = data.storagePath || "";

      // Storage delete
      if(storagePath){
        try{
          await storage.ref(storagePath).delete();
        }catch(e){
          console.warn("Storage delete failed:", e);
        }
      } else if (data.url) {
        // fallback
        try{
          await storage.refFromURL(data.url).delete();
        }catch(e){}
      }

      // Firestore delete
      await docRef.delete();

      setHeroInfo("‚úÖ Gel√∂scht.");
      await loadHeroImages();
    }catch(e){
      setHeroInfo("‚ùå L√∂schen fehlgeschlagen: " + (e?.message || e));
    }
  }

  // Buttons
  heroUploadBtn.addEventListener("click", uploadHeroImage);
  heroReloadBtn.addEventListener("click", loadHeroImages);

  // Global (f√ºr onclick im HTML)
  window.deleteHeroImage = deleteHeroImage;

  // ========= Laden & Render (Eintr√§ge) =========
  async function loadType(type){
    setStatus("‚è≥ Lade " + type + "‚Ä¶", "");
    listEl.innerHTML = "‚è≥ Lade‚Ä¶";

    try{
      const snap = await db.collection("entries")
        .orderBy("created","desc")
        .limit(200)
        .get();

      const items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
        .filter(d => d.type === type);

      if(!items.length){
        listEl.innerHTML = "<div class='muted'>Noch keine Eintr√§ge.</div>";
        setStatus("‚úÖ Keine Eintr√§ge gefunden.", "ok");
        return;
      }

      listEl.innerHTML = items.map(d => renderEntry(d)).join("");
      setStatus("‚úÖ Geladen: " + items.length + " Eintr√§ge.", "ok");
    }catch(e){
      listEl.innerHTML = "";
      setStatus("‚ùå Fehler beim Laden: " + (e?.message || e), "err");
    }
  }

  function renderEntry(d){
    const a = d.answers || {};
    const name = a.name || a.fb_name || a.gb_name || "Unbekannt";
    const time = formatDate(d.created);

    const preview = Object.entries(a).slice(0, 6).map(([k,v]) =>
      `<div class="q">${esc(k)}</div><div class="a">${esc(v)}</div>`
    ).join("");

    return `
      <div class="entry" data-id="${esc(d.id)}">
        <div class="row">
          <div>
            <p class="name">${esc(name)}</p>
            <div class="meta">${esc(time)} ‚Ä¢ <span class="pill">${esc(d.type)}</span></div>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn btnDanger" onclick="deleteEntry('${esc(d.id)}')" style="min-width:160px">üóëÔ∏è L√∂schen</button>
          </div>
        </div>

        ${d.imageUrl ? `<img src="${esc(d.imageUrl)}" alt="Foto">` : ""}
        ${preview}
      </div>
    `;
  }

  async function deleteEntry(docId){
    const user = auth.currentUser;
    if(!isAdmin(user)){
      setStatus("‚ùå L√∂schen nur als Admin.", "err");
      return;
    }
    if(!confirm("Wirklich l√∂schen? (Dokument + ggf. Bild)")) return;

    setStatus("‚è≥ L√∂sche‚Ä¶", "");

    try{
      const ref = db.collection("entries").doc(docId);
      const snap = await ref.get();
      if(!snap.exists){
        setStatus("‚ö†Ô∏è Eintrag existiert nicht mehr.", "err");
        return;
      }

      const data = snap.data() || {};
      const imageUrl = data.imageUrl || "";

      if(imageUrl){
        try{
          const storageRef = storage.refFromURL(imageUrl);
          await storageRef.delete();
        }catch(imgErr){
          console.warn("Bild l√∂schen fehlgeschlagen:", imgErr);
        }
      }

      await ref.delete();

      const node = document.querySelector(`.entry[data-id="${CSS.escape(docId)}"]`);
      if(node) node.remove();

      setStatus("‚úÖ Gel√∂scht.", "ok");
    }catch(e){
      setStatus("‚ùå L√∂schen fehlgeschlagen: " + (e?.message || e), "err");
    }
  }

  el("loadFreund").addEventListener("click", () => loadType("freundebuch"));
  el("loadGast").addEventListener("click", () => loadType("gaestebuch"));

  window.deleteEntry = deleteEntry;
</script>
</body>
</html>