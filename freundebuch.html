<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Freundebuch</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#0f172a;color:#f8fafc}
  main{max-width:820px;margin:auto;padding:20px}
  .card{background:#020617;border:1px solid #1e293b;border-radius:16px;padding:16px;margin-bottom:16px}
  h1,h2{margin:0 0 10px}
  label{font-size:13px;color:#94a3b8}
  input,select,textarea,button{width:100%;padding:12px;margin-top:6px;margin-bottom:12px;border-radius:12px;border:1px solid #334155;background:#020617;color:#f8fafc}
  textarea{min-height:80px}
  button{background:linear-gradient(135deg,#6366f1,#22d3ee);border:none;font-weight:700;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .entry{border:1px solid #1e293b;border-radius:16px;padding:14px;margin-top:14px;background:#020617}
  .entry h3{margin:0}
  .q{color:#94a3b8;font-size:13px;margin-top:10px}
  .a{margin-top:4px;white-space:pre-wrap}
  img{width:100%;border-radius:14px;margin-top:10px}
  hr{border:none;border-top:1px solid #1e293b;margin:14px 0}
  .status{margin-top:10px;font-weight:800}
  .ok{color:#34d399}
  .err{color:#fb7185}
</style>
</head>

<body>
<main>

<h1>ðŸ“˜ Freundebuch</h1>

<div class="card">
  <label>Dein Name *</label>
  <input id="fb_name" placeholder="z.B. Max">

  <label>Woher kennen wir uns? *</label>
  <select id="fb_kennen">
    <option value="">Bitte wÃ¤hlen</option>
    <option>Arbeit</option>
    <option>Freunde</option>
    <option>Feier / Event</option>
    <option>Online</option>
    <option>Sonstiges</option>
  </select>

  <label>Wie lange kennen wir uns? *</label>
  <select id="fb_dauer">
    <option value="">Bitte wÃ¤hlen</option>
    <option>Heute</option>
    <option>Monate</option>
    <option>1â€“2 Jahre</option>
    <option>3â€“5 Jahre</option>
    <option>5+ Jahre</option>
  </select>

  <label>3 Worte, die mich beschreiben *</label>
  <input id="fb_worte" placeholder="z.B. loyal, lustig, direkt">

  <label>Worauf freust du dich gerade?</label>
  <input id="fb_freu" placeholder="optional">

  <hr>

  <label>Auswahlspiel (alle Pflicht) *</label>
  <select id="fb_a1"><option value="">DÃ¶ner oder Pizza</option><option>DÃ¶ner</option><option>Pizza</option></select>
  <select id="fb_a2"><option value="">Bier oder Wein</option><option>Bier</option><option>Wein</option><option>Keins</option></select>
  <select id="fb_a3"><option value="">Netflix oder YouTube</option><option>Netflix</option><option>YouTube</option><option>Beides</option></select>
  <select id="fb_a4"><option value="">Nacht oder FrÃ¼h</option><option>Nachtmensch</option><option>FrÃ¼haufsteher</option><option>Kommt drauf an</option></select>
  <select id="fb_a5"><option value="">Spontan oder geplant</option><option>Spontan</option><option>Geplant</option><option>Mix</option></select>

  <label>Emoji *</label>
  <select id="fb_emoji">
    <option value="">Bitte wÃ¤hlen</option>
    <option>ðŸ˜„</option><option>ðŸ˜Ž</option><option>ðŸ¥³</option><option>ðŸ«¶</option><option>ðŸ”¥</option><option>ðŸ™‚</option>
  </select>

  <label>Foto (optional)</label>
  <input type="file" id="fb_image" accept="image/*">

  <button id="saveBtn" onclick="saveEntry()">Eintrag speichern</button>
  <div class="status" id="status"></div>
</div>

<h2>ðŸ“Œ EintrÃ¤ge</h2>
<div id="entries"></div>

</main>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCLnz3t9VcQJLg2oqbZd2cA7-hXF30UyHM",
    authDomain: "freundebuch-neu.firebaseapp.com",
    projectId: "freundebuch-neu",
    storageBucket: "freundebuch-neu.firebasestorage.app",
    messagingSenderId: "732597691942",
    appId: "1:732597691942:web:2c116f530c4179d1c2a8e7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const entriesEl = $("entries");
  const saveBtn = $("saveBtn");

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function uploadImage(file){
    const safeName = (file.name || "bild").replace(/\s+/g, "_");
    const ref = storage.ref("uploads/" + Date.now() + "_" + safeName);
    await ref.put(file);
    return await ref.getDownloadURL();
  }

  async function saveEntry(){
    statusEl.className = "status";
    statusEl.textContent = "";

    const data = {
      name: $("fb_name").value.trim(),
      kennen: $("fb_kennen").value,
      dauer: $("fb_dauer").value,
      worte: $("fb_worte").value.trim(),
      freu: $("fb_freu").value.trim(),
      a1: $("fb_a1").value,
      a2: $("fb_a2").value,
      a3: $("fb_a3").value,
      a4: $("fb_a4").value,
      a5: $("fb_a5").value,
      emoji: $("fb_emoji").value
    };

    const requiredKeys = ["name","kennen","dauer","worte","a1","a2","a3","a4","a5","emoji"];
    const missing = requiredKeys.filter(k => !data[k]);
    if(missing.length){
      statusEl.classList.add("err");
      statusEl.textContent = "âŒ Bitte alles Pflichtige auswÃ¤hlen/ausfÃ¼llen (inkl. Emoji & Auswahlspiel).";
      return;
    }

    saveBtn.disabled = true;
    statusEl.textContent = "â³ Speichernâ€¦";

    try{
      const file = $("fb_image").files[0];
      let imageUrl = "";
      if(file){
        statusEl.textContent = "â³ Bild hochladenâ€¦";
        imageUrl = await uploadImage(file);
      }

      await db.collection("entries").add({
        type: "freundebuch",
        created: firebase.firestore.FieldValue.serverTimestamp(),
        imageUrl,
        answers: data
      });

      statusEl.classList.add("ok");
      statusEl.textContent = "âœ… Gespeichert!";
      await loadEntries();

    }catch(e){
      statusEl.classList.add("err");
      statusEl.textContent = "âŒ Fehler: " + (e?.message || e);
    }finally{
      saveBtn.disabled = false;
    }
  }

  function formatDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : new Date();
      return d.toLocaleString("de-DE");
    }catch{ return ""; }
  }

  async function loadEntries(){
    entriesEl.textContent = "â³ Ladeâ€¦";

    // Index-frei: nur orderBy, dann im Browser filtern
    const snap = await db.collection("entries")
      .orderBy("created","desc")
      .limit(80)
      .get();

    const docs = snap.docs
      .map(d => d.data())
      .filter(d => d.type === "freundebuch");

    if(!docs.length){
      entriesEl.innerHTML = "<div style='color:#94a3b8'>Noch keine EintrÃ¤ge.</div>";
      return;
    }

    entriesEl.innerHTML = docs.map(d => {
      const a = d.answers || {};
      return `
        <div class="entry">
          <h3>${esc(a.name || "Unbekannt")}</h3>
          <div class="q">Woher kennen wir uns?</div><div class="a">${esc(a.kennen)}</div>
          <div class="q">Wie lange kennen wir uns?</div><div class="a">${esc(a.dauer)}</div>
          <div class="q">3 Worte, die mich beschreiben</div><div class="a">${esc(a.worte)}</div>
          ${a.freu ? `<div class="q">Worauf freust du dich gerade?</div><div class="a">${esc(a.freu)}</div>` : ""}
          <div class="q">Auswahlspiel</div>
          <div class="a">${esc([a.a1,a.a2,a.a3,a.a4,a.a5].join(" â€¢ "))}</div>
          <div class="q">Emoji</div><div class="a">${esc(a.emoji)}</div>
          ${d.imageUrl ? `<img src="${esc(d.imageUrl)}" alt="Foto">` : ""}
          <div class="q">Zeit</div><div class="a">${esc(formatDate(d.created))}</div>
        </div>
      `;
    }).join("");
  }

  loadEntries();
</script>
</body>
</html>