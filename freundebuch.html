<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Freundebuch</title>
  <link rel="stylesheet" href="styles.css">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="bg"></div>

  <main class="shell" id="app">
    <header class="hero">
      <div class="badge">ğŸ“—</div>
      <div>
        <h1>Freundebuch</h1>
        <p class="muted">Mittel & locker â€“ Erwachsene. (Eintrag + Foto optional)</p>
      </div>
    </header>

    <section class="card">
      <div class="pill">ğŸ”— Du bist auf der richtigen Seite</div>

      <div class="label">Dein Name *</div>
      <input class="input" id="name" placeholder="z.B. Tizian" />

      <div class="row two">
        <div>
          <div class="label">Woher kennen wir uns? *</div>
          <select class="input" id="q_kennen">
            <option value="">Bitte wÃ¤hlenâ€¦</option>
            <option>Arbeit / Kolleg:innen</option>
            <option>Schule / Ausbildung / Uni</option>
            <option>Freunde / Party / Bar</option>
            <option>Sport / Verein</option>
            <option>Online / Social Media</option>
            <option>Sonstiges</option>
          </select>
        </div>
        <div>
          <div class="label">Wie lange kennen wir uns? *</div>
          <select class="input" id="q_dauer">
            <option value="">Bitte wÃ¤hlenâ€¦</option>
            <option>Erst heute</option>
            <option>Ein paar Wochen</option>
            <option>Ein paar Monate</option>
            <option>1â€“2 Jahre</option>
            <option>3â€“5 Jahre</option>
            <option>5+ Jahre</option>
          </select>
        </div>
      </div>

      <div class="label">3 Worte, die mich beschreiben *</div>
      <input class="input" id="q_3worte" placeholder="z.B. loyal, lustig, direkt" />

      <div class="label">Worauf freust du dich gerade am meisten?</div>
      <input class="input" id="q_freust" placeholder="z.B. Urlaub, Wochenende, Konzertâ€¦" />

      <hr class="soft">

      <h2>ğŸ¯ Auswahlspiel (5 Pflicht-Fragen)</h2>
      <p class="muted tiny">Du musst alle 5 auswÃ¤hlen ğŸ™‚</p>

      <div class="row two">
        <div>
          <div class="label">1) DÃ¶ner oder Pizza? *</div>
          <select class="input" id="a1"><option value="">WÃ¤hlenâ€¦</option><option>DÃ¶ner</option><option>Pizza</option></select>
        </div>
        <div>
          <div class="label">2) Bier oder Wein? *</div>
          <select class="input" id="a2"><option value="">WÃ¤hlenâ€¦</option><option>Bier</option><option>Wein</option><option>Beides</option><option>Keins</option></select>
        </div>
        <div>
          <div class="label">3) Netflix oder YouTube? *</div>
          <select class="input" id="a3"><option value="">WÃ¤hlenâ€¦</option><option>Netflix</option><option>YouTube</option><option>Beides</option></select>
        </div>
        <div>
          <div class="label">4) Nachtmensch oder FrÃ¼haufsteher? *</div>
          <select class="input" id="a4"><option value="">WÃ¤hlenâ€¦</option><option>Nachtmensch</option><option>FrÃ¼haufsteher</option><option>Kommt drauf an</option></select>
        </div>
        <div>
          <div class="label">5) Spontan oder geplant? *</div>
          <select class="input" id="a5"><option value="">WÃ¤hlenâ€¦</option><option>Spontan</option><option>Geplant</option><option>Mix</option></select>
        </div>
      </div>

      <hr class="soft">

      <div class="label">Emoji-Stimmung *</div>
      <select class="input" id="emoji">
        <option value="">Bitte wÃ¤hlenâ€¦</option>
        <option>ğŸ˜„</option><option>ğŸ˜</option><option>ğŸ¥³</option><option>ğŸ«¶</option><option>ğŸ”¥</option><option>ğŸ¤</option><option>ğŸ¤¯</option><option>ğŸ˜´</option><option>ğŸ¤</option>
      </select>

      <div class="label">Foto (optional)</div>
      <input class="input" type="file" id="image" accept="image/*" capture="environment"/>

      <div class="row two">
        <div>
          <div class="label">Likes erlauben?</div>
          <select class="input" id="allowLikes">
            <option value="yes" selected>Ja</option>
            <option value="no">Nein</option>
          </select>
        </div>
        <div>
          <div class="label">Kommentare erlauben?</div>
          <select class="input" id="allowComments">
            <option value="yes" selected>Ja</option>
            <option value="no">Nein</option>
          </select>
        </div>
      </div>

      <div class="label">Optional â€“ wenn du willst ğŸ™‚ (kurzer Zusatz)</div>
      <textarea class="input" id="note" placeholder="z.B. Insider, kurzer GruÃŸ, irgendwas Lustigesâ€¦"></textarea>

      <button class="primary" id="saveBtn">Eintrag speichern</button>
      <div class="notice" id="status"></div>
    </section>

    <section class="card" style="margin-top:14px;">
      <div class="entriesHeader">
        <h2>ğŸ“Œ Freundebuch-EintrÃ¤ge</h2>
        <button class="actionBtn" id="reloadBtn">Neu laden</button>
      </div>
      <p class="muted tiny">Neueste zuerst.</p>
      <div id="entries"></div>
    </section>
  </main>

  <a class="adminFab" href="admin.html" title="Admin">ğŸ”’</a>

<script>
  // ========= Firebase =========
  const firebaseConfig = {
    apiKey: "AIzaSyCLnz3t9VcQJLg2oqbZd2cA7-hXF30UyHM",
    authDomain: "freundebuch-neu.firebaseapp.com",
    projectId: "freundebuch-neu",
    storageBucket: "freundebuch-neu.firebasestorage.app",
    messagingSenderId: "732597691942",
    appId: "1:732597691942:web:2c116f530c4179d1c2a8e7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();
  const auth = firebase.auth();

  const ADMIN_EMAIL = "male01.w@gmail.com";

  const esc = (s) => String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  function getLocalUid(){
    let uid = localStorage.getItem("fb_uid");
    if(!uid){
      uid = "u_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
      localStorage.setItem("fb_uid", uid);
    }
    return uid;
  }

  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts));
      return d.toLocaleString("de-DE", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch(e){ return ""; }
  }

  // Voll ausgeschriebene Fragen (werden in den EintrÃ¤gen auch komplett angezeigt)
  const QUESTIONS = [
    ["Woher kennen wir uns?", "q_kennen"],
    ["Wie lange kennen wir uns?", "q_dauer"],
    ["3 Worte, die mich beschreiben", "q_3worte"],
    ["Worauf freust du dich gerade am meisten?", "q_freust"],
    ["Emoji-Stimmung", "emoji"],
    ["Optionaler Zusatz", "note"]
  ];

  const CHOICEGAME = [
    ["DÃ¶ner oder Pizza?", "a1"],
    ["Bier oder Wein?", "a2"],
    ["Netflix oder YouTube?", "a3"],
    ["Nachtmensch oder FrÃ¼haufsteher?", "a4"],
    ["Spontan oder geplant?", "a5"],
  ];

  const statusEl = document.getElementById("status");
  const entriesEl = document.getElementById("entries");

  async function uploadImage(file){
    const ref = storage.ref("uploads/" + Date.now() + "_" + file.name.replaceAll(" ", "_"));
    await ref.put(file);
    return await ref.getDownloadURL();
  }

  async function saveEntry(){
    statusEl.innerHTML = "";
    const name = document.getElementById("name").value.trim();
    const must = [
      ["Name", name],
      ["Woher kennen wir uns?", document.getElementById("q_kennen").value],
      ["Wie lange kennen wir uns?", document.getElementById("q_dauer").value],
      ["3 Worte", document.getElementById("q_3worte").value.trim()],
      ["Emoji", document.getElementById("emoji").value],
      ["Auswahlspiel 1", document.getElementById("a1").value],
      ["Auswahlspiel 2", document.getElementById("a2").value],
      ["Auswahlspiel 3", document.getElementById("a3").value],
      ["Auswahlspiel 4", document.getElementById("a4").value],
      ["Auswahlspiel 5", document.getElementById("a5").value],
    ];
    const missing = must.filter(x => !x[1]).map(x => x[0]);
    if(missing.length){
      statusEl.innerHTML = `<div class="error">Bitte ausfÃ¼llen: ${esc(missing.join(", "))}</div>`;
      return;
    }

    const file = document.getElementById("image").files[0];
    let imageUrl = "";
    if(file){
      statusEl.innerHTML = `<div class="muted">Bild wird hochgeladenâ€¦</div>`;
      imageUrl = await uploadImage(file);
    }

    const doc = {
      type: "freundebuch",
      name,
      allowLikes: document.getElementById("allowLikes").value === "yes",
      allowComments: document.getElementById("allowComments").value === "yes",
      imageUrl,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      clientUid: getLocalUid(),

      // Antworten
      answers: {
        q_kennen: document.getElementById("q_kennen").value,
        q_dauer: document.getElementById("q_dauer").value,
        q_3worte: document.getElementById("q_3worte").value.trim(),
        q_freust: document.getElementById("q_freust").value.trim(),
        emoji: document.getElementById("emoji").value,
        note: document.getElementById("note").value.trim(),

        a1: document.getElementById("a1").value,
        a2: document.getElementById("a2").value,
        a3: document.getElementById("a3").value,
        a4: document.getElementById("a4").value,
        a5: document.getElementById("a5").value
      },

      likesCount: 0
    };

    await db.collection("entries").add(doc);

    statusEl.innerHTML = `<div class="success">âœ… Gespeichert!</div>`;
    document.getElementById("saveBtn").disabled = true;
    setTimeout(()=> document.getElementById("saveBtn").disabled = false, 1200);

    // optional: Eingaben leeren
    // location.reload();

    await loadEntries();
  }

  async function toggleLike(entryId, allowed){
    if(!allowed) return;
    const uid = getLocalUid();
    const likeRef = db.collection("entries").doc(entryId).collection("likes").doc(uid);
    const entryRef = db.collection("entries").doc(entryId);

    await db.runTransaction(async (tx) => {
      const likeSnap = await tx.get(likeRef);
      const entrySnap = await tx.get(entryRef);
      const cur = entrySnap.data()?.likesCount || 0;

      if(likeSnap.exists){
        tx.delete(likeRef);
        tx.update(entryRef, { likesCount: Math.max(0, cur - 1) });
      }else{
        tx.set(likeRef, { createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        tx.update(entryRef, { likesCount: cur + 1 });
      }
    });

    await loadEntries();
  }

  async function addComment(entryId, text, allowed){
    if(!allowed) return;
    const t = (text||"").trim();
    if(!t) return;
    await db.collection("entries").doc(entryId).collection("comments").add({
      text: t,
      clientUid: getLocalUid(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    await loadEntries();
  }

  function renderQA(label, value){
    if(!value) return "";
    return `
      <div>
        <div class="q">${esc(label)}</div>
        <div class="a">${esc(value)}</div>
      </div>`;
  }

  function renderEntryCard(id, data){
    const created = fmtDate(data.createdAt);
    const tag = data.type === "gaestebuch" ? "ğŸ“ GÃ¤stebuch" : "ğŸ“— Freundebuch";

    const ans = data.answers || {};
    const qaParts = [];

    // normale Fragen
    for(const [label, key] of QUESTIONS){
      if(key === "note" && !ans[key]) continue;
      qaParts.push(renderQA(label, ans[key]));
    }

    // Auswahlspiel zusammen
    const choices = CHOICEGAME.map(([label, key]) => ans[key]).filter(Boolean);
    if(choices.length){
      qaParts.splice(4, 0, renderQA("Auswahlspiel (5 Antworten)", choices.join(" â€¢ ")));
    }

    const likesAllowed = !!data.allowLikes;
    const commentsAllowed = !!data.allowComments;
    const likesCount = data.likesCount || 0;

    return `
      <article class="entry">
        <div class="entryTop">
          <div>
            <div class="entryName">${esc(data.name || "Unbekannt")}</div>
            <div class="entryMeta">ğŸ•’ ${esc(created)}</div>
          </div>
          <div class="tag">${esc(tag)}</div>
        </div>

        <div class="entryBody">
          ${data.imageUrl ? `<div class="photo"><img src="${esc(data.imageUrl)}" alt="Foto"></div>` : ""}

          <div class="qa">
            ${qaParts.join("")}
          </div>

          <div class="actions">
            <button class="actionBtn" onclick="toggleLike('${esc(id)}', ${likesAllowed})" ${likesAllowed ? "" : "disabled"} title="${likesAllowed ? "GefÃ¤llt mir" : "Likes deaktiviert"}">
              â¤ï¸ GefÃ¤llt mir (${likesCount})
            </button>

            <button class="actionBtn" onclick="document.getElementById('c_${esc(id)}').classList.toggle('open')" ${commentsAllowed ? "" : "disabled"} title="${commentsAllowed ? "Kommentare" : "Kommentare deaktiviert"}">
              ğŸ’¬ Kommentare
            </button>
          </div>

          <div id="c_${esc(id)}" style="margin-top:10px; display:none;">
            <div class="label">Kommentar schreiben</div>
            <input class="input" id="ci_${esc(id)}" placeholder="Kurzer Kommentarâ€¦" />
            <button class="actionBtn" style="margin-top:8px;" onclick="addComment('${esc(id)}', document.getElementById('ci_${esc(id)}').value, ${commentsAllowed})">Senden</button>
            <div style="margin-top:10px;">
              ${(data._comments || []).map(c => `
                <div style="padding:10px 10px; border:1px solid rgba(255,255,255,.10); border-radius:14px; margin-top:8px; background: rgba(255,255,255,.05);">
                  <div class="tiny muted">${esc(fmtDate(c.createdAt))}</div>
                  <div>${esc(c.text)}</div>
                </div>
              `).join("")}
            </div>
          </div>

        </div>
      </article>
    `;
  }

  async function loadEntries(){
    entriesEl.innerHTML = `<div class="muted">Lade EintrÃ¤geâ€¦</div>`;

    const snap = await db.collection("entries")
      .where("type", "==", "freundebuch")
      .orderBy("createdAt", "desc")
      .limit(30)
      .get();

    const docs = [];
    for(const d of snap.docs){
      const data = d.data();

      // comments holen (max 10)
      const cs = await db.collection("entries").doc(d.id).collection("comments")
        .orderBy("createdAt","desc").limit(10).get();
      data._comments = cs.docs.map(x => x.data());

      docs.push([d.id, data]);
    }

    if(!docs.length){
      entriesEl.innerHTML = `<div class="muted">Noch keine EintrÃ¤ge.</div>`;
      return;
    }

    entriesEl.innerHTML = docs.map(([id, data]) => renderEntryCard(id, data)).join("");

    // Kommentarbereich togglen (kleiner Trick: display umschalten)
    // Wir hÃ¤ngen hier einen einfachen Listener dran:
    setTimeout(()=>{
      document.querySelectorAll("[id^='c_']").forEach(el=>{
        el.classList.remove("open");
      });
    }, 10);
  }

  // Kommentar-Container Ã¶ffnen/schlieÃŸen
  const _oldToggle = Element.prototype.classList?.toggle;
  // (kein override nÃ¶tig) wir machenâ€™s via inline onclick + style switch:
  // -> Daher hier: kleinen Patch fÃ¼r open class:
  const style = document.createElement("style");
  style.textContent = `[id^="c_"].open{display:block!important;}`;
  document.head.appendChild(style);

  document.getElementById("saveBtn").addEventListener("click", saveEntry);
  document.getElementById("reloadBtn").addEventListener("click", loadEntries);

  loadEntries();
</script>
</body>
</html>