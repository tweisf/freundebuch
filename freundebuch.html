<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Freundebuch</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#0f172a;color:#f8fafc}
  main{max-width:820px;margin:auto;padding:20px}
  .card{background:#020617;border:1px solid #1e293b;border-radius:16px;padding:16px;margin-bottom:16px}
  h1,h2{margin:0 0 10px}
  label{font-size:13px;color:#94a3b8}
  input,select,textarea,button{
    width:100%;padding:12px;margin-top:6px;margin-bottom:12px;border-radius:12px;
    border:1px solid #334155;background:#020617;color:#f8fafc
  }
  textarea{min-height:80px;resize:vertical}
  button{background:linear-gradient(135deg,#6366f1,#22d3ee);border:none;font-weight:800;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .entry{border:1px solid #1e293b;border-radius:16px;padding:14px;margin-top:14px;background:#020617}
  .entry h3{margin:0}
  .q{color:#94a3b8;font-size:13px;margin-top:10px}
  .a{margin-top:4px;white-space:pre-wrap}
  img{width:100%;border-radius:14px;margin-top:10px}
  hr{border:none;border-top:1px solid #1e293b;margin:14px 0}
  .status{margin-top:10px;font-weight:800}
  .ok{color:#34d399}
  .err{color:#fb7185}
  .muted{color:#94a3b8;font-size:13px}

  /* Back + Admin dot */
  .backLink{
    position:fixed;top:12px;left:12px;font-size:13px;color:#94a3b8;text-decoration:none;
    padding:6px 8px;border-radius:8px;background:rgba(2,6,23,.6);
    border:1px solid #1e293b;z-index:1000
  }
  .backLink:hover{color:#e5e7eb;border-color:#334155}
  .adminDot{
    position:fixed;right:10px;bottom:10px;width:12px;height:12px;border-radius:50%;
    background:#334155;opacity:.5;z-index:1000
  }
  .adminDot:hover{opacity:1;background:#64748b}

  /* Social links pills */
  .socialRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  .pillLink{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:999px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    color:#e5e7eb;text-decoration:none;
    font-size:13px;font-weight:800;
  }
  .pillLink:hover{border-color:rgba(255,255,255,.22)}
  .pillLink small{font-weight:700;color:#94a3b8}

  /* Likes + Kommentare */
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .miniBtn{
    width:auto;padding:10px 12px;margin:0;border-radius:12px;
    border:1px solid rgba(255,255,255,.15);
    background:rgba(255,255,255,.06);
    color:#fff;font-weight:700;cursor:pointer
  }
  .miniBtn:disabled{opacity:.5;cursor:not-allowed}
  .comments{margin-top:12px;padding:12px;border-radius:14px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08)}
  .comItem{padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08)}
  .comItem:last-child{border-bottom:none}

  /* Kommentar: Name + Kommentar + Admin lÃ¶schen */
  .comHeader{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
  .comName{font-weight:900}
  .delCom{
    border:none;background:transparent;color:#fb7185;cursor:pointer;
    font-weight:900;padding:6px 8px;border-radius:10px;width:auto;
  }
  .delCom:hover{background:rgba(251,113,133,.12)}

  /* Kommentar-Form mit 2 Inputs */
  .comForm{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
  .comForm input{margin:0}
  .comForm input:first-child{flex:0 0 160px;min-width:140px}
  .comForm input:nth-child(2){flex:1;min-width:160px}
  .comForm button{width:auto;margin:0;padding:10px 14px;border-radius:12px}
  
  /* âœ… Admin: Edit Overlay */
#editOverlay{
  position:fixed; inset:0; z-index:99999;
  display:flex; align-items:center; justify-content:center;
  background:rgba(2,6,23,.82);
  backdrop-filter: blur(10px);
}
#editCard{
  width:min(520px,92vw);
  background:#020617;
  border:1px solid #1e293b;
  border-radius:18px;
  padding:16px;
  color:#f8fafc;
  box-shadow:0 20px 60px rgba(0,0,0,.45);
}
#editTitle{font-size:18px;font-weight:900;margin-bottom:4px;}
#editSub{color:#94a3b8;font-size:12px;margin-bottom:12px;}
.editLbl{display:block;color:#94a3b8;font-size:12px;margin:8px 0 6px;}
#editName, #editDauerT, #editDauerM, #editJson{
  border-radius:14px;
  border:1px solid #334155;
  background:#0b1220;
  color:#f8fafc;
  padding:12px;
  outline:none;
}
.editRow{display:flex; gap:10px; margin-top:14px;}
.editBtnGhost{
  flex:1; padding:12px; border-radius:14px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.06);
  color:#e5e7eb; font-weight:900; cursor:pointer;
}
.editBtnSave{
  flex:1; padding:12px; border-radius:14px;
  border:none; font-weight:900; cursor:pointer;
  background:linear-gradient(135deg,#60a5fa,#a78bfa); color:#06122a;
}
</style>
</head>

<body>
  
  <script>
  // ===== Session-Check (1h) =====
  const SESSION_KEY = "fb_pass_ok_at";
  const TTL_MS = 60 * 60 * 1000; // 1 Stunde
  
  function isSessionValid() {
    const t = Number(localStorage.getItem(SESSION_KEY) || 0);
    return t && (Date.now() - t) < TTL_MS;
  }
  
  if (!isSessionValid()) {
    // Session abgelaufen / nicht vorhanden -> zurÃ¼ck zu index (dort kommt Popup)
    location.replace("index.html");
  }
  // ===== Admin-Notfall-Kill-Signal =====
const ADMIN_KILL_KEY = "fb_admin_kill_at";

window.addEventListener("storage", (e) => {
  if (e.key === ADMIN_KILL_KEY) {
    // sofort raus
    location.replace("index.html");
  }
});
</script>
  
  <!-- Passwort-Sperre -->
<div id="lockOverlay" style="
  position:fixed; inset:0; z-index:9999;
  display:none; align-items:center; justify-content:center;
  background:rgba(2,6,23,.88); backdrop-filter: blur(10px);
">
  <div style="
    width:min(420px,92vw);
    background:#020617; border:1px solid #1e293b;
    border-radius:18px; padding:16px;
    color:#f8fafc; box-shadow:0 20px 60px rgba(0,0,0,.45);
  ">
    <div style="font-size:20px;font-weight:900;margin-bottom:6px;">ğŸ”’ Zugang</div>
    <div style="color:#94a3b8;font-size:13px;margin-bottom:12px;">
      Bitte Passwort eingeben, um fortzufahren.
    </div>

    <input id="pwInput" type="password" inputmode="numeric" placeholder="Passwort"
      style="width:100%; padding:12px; border-radius:14px; border:1px solid #334155;
             background:#0b1220; color:#f8fafc; outline:none;">
    <button id="pwBtn" style="
      width:100%; margin-top:10px; padding:12px; border-radius:14px;
      border:none; font-weight:900; cursor:pointer;
      background:linear-gradient(135deg,#60a5fa,#a78bfa); color:#06122a;
    ">Weiter</button>

    <div id="pwMsg" style="margin-top:10px; font-weight:900; color:#fb7185; display:none;">
      âŒ Falsches Passwort
    </div>
  </div>
</div>

<a href="index.html" class="backLink">â† zurÃ¼ck</a>
<a href="admin.html" class="adminDot" title="Admin"></a>

<main>

<h1>ğŸ“˜ Freundebuch</h1>

<div class="card">
  <label>ğŸ‘¤ Wie heiÃŸt du? *</label>
  <input id="fb_name" placeholder="z.B. Max">

  <hr>

  <h2 style="margin:6px 0 10px;">ğŸ‘¤ FÃ¼r Tizian (optional)</h2>

  <label>ğŸ¤ Woher kennen wir uns? (Tizian)</label>
  <select id="fb_kennen_t">
    <option value="">(freiwillig) auswÃ¤hlenâ€¦</option>
    <option>Arbeit / Kolleg:innen</option>
    <option>Schule / Ausbildung / Uni</option>
    <option>Familie / Freunde / Party / Bar</option>
    <option>Sport / Verein</option>
    <option>Online / Social Media</option>
    <option>Sonstiges</option>
  </select>

  <label>â³ Wie lange kennen wir uns schon? (Tizian)</label>
  <select id="fb_dauer_t">
    <option value="">(freiwillig) auswÃ¤hlenâ€¦</option>
   <option>Erst heute</option>
<option>Ein paar Wochen</option>
<option>Ein paar Monate</option>
<option>1â€“2 Jahre</option>
<option>3â€“5 Jahre</option>
<option>5â€“10 Jahre</option>
<option>10â€“15 Jahre</option>
<option>15â€“20 Jahre</option>
<option>20+ Jahre</option>
  </select>

  <label>ğŸ§© 3 WÃ¶rter, die mich beschreiben (Tizian)</label>
  <input id="fb_worte_t" placeholder="z.B. loyal, lustig, direkt (freiwillig)">

  <hr>

  <h2 style="margin:6px 0 10px;">ğŸ‘¤ FÃ¼r Mia (optional)</h2>

  <label>ğŸ¤ Woher kennen wir uns? (Mia)</label>
  <select id="fb_kennen_m">
    <option value="">(freiwillig) auswÃ¤hlenâ€¦</option>
    <option>Arbeit / Kolleg:innen</option>
    <option>Schule / Ausbildung / Uni</option>
    <option>Familie / Freunde / Party / Bar</option>
    <option>Sport / Verein</option>
    <option>Online / Social Media</option>
    <option>Sonstiges</option>
  </select>

  <label>â³ Wie lange kennen wir uns schon? (Mia)</label>
  <select id="fb_dauer_m">
    <option value="">(freiwillig) auswÃ¤hlenâ€¦</option>
<option>Erst heute</option>
<option>Ein paar Wochen</option>
<option>Ein paar Monate</option>
<option>1â€“2 Jahre</option>
<option>3â€“5 Jahre</option>
<option>5â€“10 Jahre</option>
<option>10â€“15 Jahre</option>
<option>15â€“20 Jahre</option>
<option>20+ Jahre</option>
  </select>

  <label>ğŸ§© 3 WÃ¶rter, die mich beschreiben (Mia)</label>
  <input id="fb_worte_m" placeholder="z.B. loyal, lustig, direkt (freiwillig)">

  <hr>

  <label>ğŸ Womit kann man dir immer eine Freude machen?</label>
  <input id="fb_freude" placeholder="z.B. gutes Essen, Zeit, Komplimenteâ€¦ (freiwillig)">

  <label>ğŸ’­ Wovon trÃ¤umst du â€“ heimlich oder offen?</label>
  <input id="fb_traum" placeholder="freiwillig">

  <label>ğŸ’¸ Wenn Geld keine Rolle spielen wÃ¼rde: Was wÃ¼rdest du tun?</label>
  <textarea id="fb_geld" placeholder="freiwillig"></textarea>

  <label>ğŸŒ Welchen Ort mÃ¶chtest du unbedingt sehen?</label>
  <input id="fb_ort" placeholder="freiwillig">

  <label>â˜€ï¸ Dein perfekter Sonntag besteht aus â€¦</label>
  <textarea id="fb_sonntag" placeholder="freiwillig"></textarea>

  <label>ğŸ¬ Welche Serie oder welcher Film geht immer?</label>
  <input id="fb_film" placeholder="freiwillig">

  <label>âœ¨ Was wÃ¼nschst du dir fÃ¼r die Menschen, die dieses Buch lesen?</label>
  <textarea id="fb_wunsch" placeholder="freiwillig"></textarea>

  <hr>

  <label>ğŸ“± Social Media (optional)</label>
  <label style="margin-top:8px">ğŸ“¸ Instagram (Username oder Link)</label>
  <input id="fb_instagram" placeholder="z.B. max.mustermann oder https://instagram.com/â€¦">

  <label>ğŸµ TikTok (Username oder Link)</label>
  <input id="fb_tiktok" placeholder="z.B. @max oder https://tiktok.com/@â€¦">

  <label>ğŸ‘» Snapchat (Username)</label>
  <input id="fb_snapchat" placeholder="z.B. max123">

  <hr>

  <label>ğŸ¯ Auswahlspiel (freiwillig â€“ mach so viel du willst)</label>

  <label style="margin-top:8px">ğŸ¥™ DÃ¶ner oder Pizza?</label>
  <select id="fb_a1"><option value="">(freiwillig) wÃ¤hlenâ€¦</option><option>DÃ¶ner</option><option>Pizza</option></select>

  <label>ğŸº Bier oder Wein?</label>
  <select id="fb_a2"><option value="">(freiwillig) wÃ¤hlenâ€¦</option><option>Bier</option><option>Wein</option><option>Beides</option><option>Keins</option></select>

  <label>ğŸ“º Netflix oder Disney+?</label>
  <select id="fb_a3"><option value="">(freiwillig) wÃ¤hlenâ€¦</option><option>Netflix</option><option>Disney+</option><option>Beides</option></select>

  <label>â° FrÃ¼haufsteher oder LangschlÃ¤fer?</label>
  <select id="fb_a4"><option value="">(freiwillig) wÃ¤hlenâ€¦</option><option>FrÃ¼haufsteher</option><option>LangschlÃ¤fer</option><option>Kommt drauf an</option></select>

  <label>ğŸ”€ Planen oder spontan?</label>
  <select id="fb_a5"><option value="">(freiwillig) wÃ¤hlenâ€¦</option><option>Planen</option><option>Spontan</option><option>Mix</option></select>

  <hr>

  <label>ğŸ˜„ Emoji (deine Stimmung)</label>
  <select id="fb_emoji">
    <option value="">(freiwillig) auswÃ¤hlenâ€¦</option>
    <option>ğŸ˜„</option><option>ğŸ¥³</option><option>ğŸ™‚</option><option>ğŸ˜</option><option>ğŸ«¶</option>
    <option>ğŸ”¥</option><option>ğŸ¤</option><option>ğŸ’«</option><option>ğŸ»</option><option>âœ¨</option>
  </select>

  <label>ğŸ“· Foto (optional)</label>
  <input type="file" id="fb_image" accept="image/*">

  <!-- Likes/Kommentare erlauben -->
  <label style="display:flex; gap:10px; align-items:center; margin:6px 0 0;">
    <input type="checkbox" id="allowLikes" checked style="width:auto;margin:0">
    â¤ï¸ Likes erlauben
  </label>

  <label style="display:flex; gap:10px; align-items:center; margin:8px 0 12px;">
    <input type="checkbox" id="allowComments" checked style="width:auto;margin:0">
    ğŸ’¬ Kommentare erlauben
  </label>

  <button id="saveBtn" onclick="saveEntry()">Eintrag speichern</button>
  <div class="status" id="status"></div>
</div>

<h2>ğŸ“Œ EintrÃ¤ge</h2>
<div id="entries"></div>

<hr style="border:none;border-top:1px solid #1e293b;margin:22px 0">

<h2>ğŸ¯ Auswahlspiel â€“ Wie ihr entschieden habt</h2>
<div id="gameStats" class="entry" style="margin-top:12px"></div>

</main>

<!-- âœ… Admin Edit Overlay -->
<div id="editOverlay" style="display:none;">
  <div id="editCard">
    <div id="editTitle">âœï¸ Eintrag bearbeiten</div>
    <div id="editSub">Nur Admin kann speichern.</div>
    
    <label class="editLbl">ğŸ‘¤ Name</label>
    <input id="editName" type="text" placeholder="Name">
    
    <div id="editDurWrap" style="display:none;">
      <label class="editLbl">â³ Wie lange kennen wir uns? (Tizian)</label>
      <select id="editDauerT"></select>
      
      <label class="editLbl" style="margin-top:10px;">â³ Wie lange kennen wir uns? (Mia)</label>
      <select id="editDauerM"></select>
    </div>
    
    <details style="margin-top:12px;">
      <summary style="cursor:pointer; font-weight:900;">Erweitert: ganze Antworten (JSON)</summary>
      <textarea id="editJson" rows="10" style="width:100%; margin-top:10px;"></textarea>
      <div style="color:#94a3b8;font-size:12px;margin-top:6px;">
        Achtung: JSON muss gÃ¼ltig sein, sonst wird nicht gespeichert.
      </div>
    </details>
    
    <div class="editRow">
      <button id="editCancel" type="button" class="editBtnGhost">Abbrechen</button>
      <button id="editSave" type="button" class="editBtnSave">Speichern</button>
    </div>
    
    <div id="editMsg" style="margin-top:10px;font-weight:900;display:none;"></div>
  </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCLnz3t9VcQJLg2oqbZd2cA7-hXF30UyHM",
    authDomain: "freundebuch-neu.firebaseapp.com",
    projectId: "freundebuch-neu",
    storageBucket: "freundebuch-neu.firebasestorage.app",
    messagingSenderId: "732597691942",
    appId: "1:732597691942:web:2c116f530c4179d1c2a8e7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();
  const auth = firebase.auth();

  const ADMIN_EMAIL = "male01.w@gmail.com";
  function isAdminUser(){
    const u = auth.currentUser;
    return !!u && (u.email || "").toLowerCase() === ADMIN_EMAIL.toLowerCase();
  }

  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const entriesEl = $("entries");
  const saveBtn = $("saveBtn");

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // Anonymous Login (fÃ¼r Likes/Kommentare)
  auth.onAuthStateChanged(async (user) => {
    if(!user){
      try { await auth.signInAnonymously(); } catch(e){}
    }
  });

  async function uploadImage(file) {
  // âœ… sicherstellen, dass wir anonym eingeloggt sind (fÃ¼r Storage Rules)
  if (!auth.currentUser) {
    try { await auth.signInAnonymously(); } catch (e) {}
  }
  
  const safeName = (file.name || "bild").replace(/\s+/g, "_");
  const ref = storage.ref("uploads/" + Date.now() + "_" + safeName);
  await ref.put(file);
  return await ref.getDownloadURL();
}

  function resetForm(){
    const ids = [
      "fb_name",
      "fb_worte_t","fb_worte_m",
      "fb_freude","fb_traum","fb_geld","fb_ort","fb_sonntag","fb_film","fb_wunsch",
      "fb_instagram","fb_tiktok","fb_snapchat"
    ];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if(el) el.value = "";
    });

    ["fb_kennen_t","fb_dauer_t","fb_kennen_m","fb_dauer_m","fb_a1","fb_a2","fb_a3","fb_a4","fb_a5","fb_emoji"]
      .forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = "";
      });

    const img = document.getElementById("fb_image");
    if(img) img.value = "";

    document.getElementById("allowLikes").checked = true;
    document.getElementById("allowComments").checked = true;
  }

  function trimStr(s) { return (s || "").trim(); }

  function displayHandle(raw) {
    const v = trimStr(raw);
    if (!v) return "";
    if (/^https?:\/\//i.test(v)) {
      try {
        const u = new URL(v);
        const parts = u.pathname.split("/").filter(Boolean);
        const last = parts[parts.length - 1] || "";
        return last ? ("@" + last.replace(/^@/, "")) : v;
      } catch {
        return v;
      }
    }
    return "@" + v.replace(/^@/, "");
  }

  function buildSocialLink(platform, raw) {
    const v = trimStr(raw);
    if (!v) return "";
    if (/^https?:\/\//i.test(v)) return v;

    const handle = v.replace(/^@/, "").trim();
    const enc = encodeURIComponent(handle);

    if (platform === "instagram") return "https://instagram.com/" + enc;
    if (platform === "tiktok") return "https://www.tiktok.com/@" + enc;
    if (platform === "snapchat") {
  // Deep Link: versucht Snapchat App zu Ã¶ffnen
  return "snapchat://add/" + enc;
}

    return "";
  }

  async function saveEntry(){
    statusEl.className = "status";
    statusEl.textContent = "";

    const name = $("fb_name").value.trim();
    if(!name){
      statusEl.classList.add("err");
      statusEl.textContent = "âŒ Bitte mindestens deinen Namen eintragen.";
      return;
    }

    const data = {
      name,

      t: {
        kennen: $("fb_kennen_t").value,
        dauer: $("fb_dauer_t").value,
        worte: $("fb_worte_t").value.trim(),
      },

      m: {
        kennen: $("fb_kennen_m").value,
        dauer: $("fb_dauer_m").value,
        worte: $("fb_worte_m").value.trim(),
      },

      freude: $("fb_freude").value.trim(),
      traum: $("fb_traum").value.trim(),
      geld: $("fb_geld").value.trim(),
      ort: $("fb_ort").value.trim(),
      sonntag: $("fb_sonntag").value.trim(),
      film: $("fb_film").value.trim(),
      wunsch: $("fb_wunsch").value.trim(),

      instagram: $("fb_instagram").value.trim(),
      tiktok: $("fb_tiktok").value.trim(),
      snapchat: $("fb_snapchat").value.trim(),

      a1: $("fb_a1").value,
      a2: $("fb_a2").value,
      a3: $("fb_a3").value,
      a4: $("fb_a4").value,
      a5: $("fb_a5").value,

      emoji: $("fb_emoji").value
    };

    saveBtn.disabled = true;
    statusEl.textContent = "â³ Speichernâ€¦";

    try{
      const file = $("fb_image").files[0];
      let imageUrl = "";
      if(file){
        statusEl.textContent = "â³ Bild hochladenâ€¦";
        imageUrl = await uploadImage(file);
      }

      await db.collection("entries").add({
        type: "freundebuch",
        created: firebase.firestore.FieldValue.serverTimestamp(),
        imageUrl,
        answers: data,

        allowLikes: $("allowLikes").checked,
        allowComments: $("allowComments").checked,
        likesCount: 0
      });

      statusEl.classList.add("ok");
      statusEl.textContent = "ğŸ«¶ Danke fÃ¼rs Eintragen!";
      await loadEntries();
      resetForm();

    }catch(e){
      statusEl.classList.add("err");
      statusEl.textContent = "âŒ Fehler: " + (e?.message || e);
    }finally{
      saveBtn.disabled = false;
    }
  }

  function formatDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : new Date();
      return d.toLocaleString("de-DE");
    }catch{ return ""; }
  }

  async function ensureAnon(){
    if(!auth.currentUser){
      try { await auth.signInAnonymously(); } catch(e){}
    }
  }

  async function toggleLike(entryId){
    await ensureAnon();
    const user = auth.currentUser;
    if(!user) return;

    const entryRef = db.collection("entries").doc(entryId);
    const likeRef = entryRef.collection("likes").doc(user.uid);
    const likeSnap = await likeRef.get();

    await db.runTransaction(async (tx) => {
      const entrySnap = await tx.get(entryRef);
      const allowLikes = entrySnap.data()?.allowLikes;
      if(!allowLikes) return;

      const likesCount = entrySnap.data()?.likesCount || 0;

      if(likeSnap.exists){
        tx.delete(likeRef);
        tx.update(entryRef, { likesCount: Math.max(0, likesCount - 1) });
      } else {
        tx.set(likeRef, { created: firebase.firestore.FieldValue.serverTimestamp() });
        tx.update(entryRef, { likesCount: likesCount + 1 });
      }
    });

    const lc = document.getElementById("lc_" + entryId);
    if(lc){
      const snap = await entryRef.get();
      lc.textContent = String(snap.data()?.likesCount || 0);
    }
  }

  function toggleComments(entryId){
    const box = document.getElementById("com_" + entryId);
    if(!box) return;
    const isOpen = box.style.display !== "none";
    box.style.display = isOpen ? "none" : "block";
    if(!isOpen) startCommentsStream(entryId);
  }

  const commentUnsubs = new Map();
  function startCommentsStream(entryId){
    if(commentUnsubs.has(entryId)) return;

    const list = document.getElementById("comList_" + entryId);
    if(!list) return;

    const unsub = db.collection("entries").doc(entryId)
      .collection("comments")
      .orderBy("created","asc")
      .limit(50)
      .onSnapshot((qs) => {
        list.innerHTML = "";
        if(qs.empty){
          list.innerHTML = "<div class='muted'>Noch keine Kommentare.</div>";
          return;
        }

        const admin = isAdminUser();

        qs.forEach((doc) => {
          const c = doc.data() || {};
          const cid = doc.id;
          list.innerHTML += `
            <div class="comItem">
              <div class="comHeader">
                <div><span class="comName">${esc(c.name || "Anonym")}</span>: ${esc(c.text || "")}</div>
                ${admin ? `<button class="delCom" data-entry="${esc(entryId)}" data-cid="${esc(cid)}">LÃ¶schen</button>` : ""}
              </div>
            </div>
          `;
        });
      });

    commentUnsubs.set(entryId, unsub);
  }

  async function sendComment(entryId){
    await ensureAnon();
    const user = auth.currentUser;
    if(!user) return;

    const nameEl = document.getElementById("comName_" + entryId);
    const inputEl = document.getElementById("comInput_" + entryId);

    const name = (nameEl?.value || "").trim();
    const text = (inputEl?.value || "").trim();

    if(!name){
      alert("Bitte Name eingeben ğŸ™‚");
      return;
    }
    if(!text) return;

    await db.collection("entries").doc(entryId).collection("comments").add({
      uid: user.uid,
      name,
      text,
      created: firebase.firestore.FieldValue.serverTimestamp()
    });

    inputEl.value = "";
  }

  async function deleteComment(entryId, commentId){
    if(!isAdminUser()){
      alert("Nur Admin kann lÃ¶schen.");
      return;
    }
    if(!confirm("Kommentar wirklich lÃ¶schen?")) return;

    await db.collection("entries").doc(entryId)
      .collection("comments").doc(commentId)
      .delete();
  }

  document.addEventListener("click", (e) => {
    const likeBtn = e.target.closest(".likeBtn");
    const cBtn = e.target.closest(".cBtn");
    const sendBtn = e.target.closest(".sendCom");
    const delBtn = e.target.closest(".delCom");

    if(likeBtn) toggleLike(likeBtn.dataset.id);
    if(cBtn) toggleComments(cBtn.dataset.id);
    if(sendBtn) sendComment(sendBtn.dataset.id);
    if(delBtn) deleteComment(delBtn.dataset.entry, delBtn.dataset.cid);
  });

  async function loadEntries(){
    entriesEl.textContent = "â³ Ladeâ€¦";

    const snap = await db.collection("entries")
      .orderBy("created","desc")
      .limit(120)
      .get();

    const docs = snap.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(d => d.type === "freundebuch");

    if(!docs.length){
      entriesEl.innerHTML = "<div style='color:#94a3b8'>Noch keine EintrÃ¤ge.</div>";
      return;
    }

    function line(q, a){
      if(!a) return "";
      return `<div class="q">${q}</div><div class="a">${esc(a)}</div>`;
    }

    function personBlock(label, p) {
  const hasAny = (p?.kennen || p?.dauer || p?.worte);
  if (!hasAny) return "";
  
  return `
    <div class="personBlock">
      <div class="q">ğŸ‘¤ ${label}</div>

      ${line("ğŸ¤ Woher kennen wir uns?", p.kennen)}
      ${line("â³ Wie lange kennen wir uns schon?", p.dauer)}
      ${line("ğŸ§© 3 WÃ¶rter, die mich beschreiben", p.worte)}
    </div>
    <hr>
  `;
}

    function renderChoices(a) {
  const rows = [
    { label: "ğŸ¥™ DÃ¶ner oder Pizza?", value: a.a1 },
    { label: "ğŸº Bier oder Wein?", value: a.a2 },
    { label: "ğŸ“º Netflix oder Disney+?", value: a.a3 },
    { label: "â° FrÃ¼haufsteher oder LangschlÃ¤fer?", value: a.a4 },
    { label: "ğŸ”€ Planen oder spontan?", value: a.a5 },
  ].filter(x => x.value);
  
  if (!rows.length) return "";
  
  return `
    <div class="q">ğŸ¯ Auswahlspiel</div>
    <div class="a">
      ${rows.map(r => `<div><b>${esc(r.label)}</b> ${esc(r.value)}</div>`).join("")}
    </div>
  `;
}

    entriesEl.innerHTML = docs.map(d => {
      const a = d.answers || {};
      const likesCount = d.likesCount || 0;

      const igLink = buildSocialLink("instagram", a.instagram);
      const ttLink = buildSocialLink("tiktok", a.tiktok);
      const scLink = buildSocialLink("snapchat", a.snapchat);

      const igShow = displayHandle(a.instagram);
      const ttShow = displayHandle(a.tiktok);
      const scShow = displayHandle(a.snapchat);

      const socialHtml = (a.instagram || a.tiktok || a.snapchat) ? `
        <div class="q">ğŸ“± Social Media</div>
        <div class="a">
          <div class="socialRow">
            ${a.instagram ? `<a class="pillLink" href="${esc(igLink)}" target="_blank" rel="noopener">
              ğŸ“¸ Instagram <small>${esc(igShow)}</small>
            </a>` : ""}

            ${a.tiktok ? `<a class="pillLink" href="${esc(ttLink)}" target="_blank" rel="noopener">
              ğŸµ TikTok <small>${esc(ttShow)}</small>
            </a>` : ""}

            ${a.snapchat ? `<a class="pillLink" href="${esc(scLink)}" target="_blank" rel="noopener">
              ğŸ‘» Snapchat <small>${esc(scShow)}</small>
            </a>` : ""}
          </div>
        </div>
      ` : "";

      return `
        <div class="entry">
          <h3>ğŸ‘¤ ${esc(a.name || "Unbekannt")}</h3>

          ${personBlock("FÃ¼r Tizian", a.t)}
          ${personBlock("FÃ¼r Mia", a.m)}

          ${line("ğŸ Womit kann man dir immer eine Freude machen?", a.freude)}
          ${line("ğŸ’­ Wovon trÃ¤umst du â€“ heimlich oder offen?", a.traum)}
          ${line("ğŸ’¸ Wenn Geld keine Rolle spielen wÃ¼rde: Was wÃ¼rdest du tun?", a.geld)}
          ${line("ğŸŒ Welchen Ort mÃ¶chtest du unbedingt sehen?", a.ort)}
          ${line("â˜€ï¸ Dein perfekter Sonntag besteht aus â€¦", a.sonntag)}
          ${line("ğŸ¬ Welche Serie oder welcher Film geht immer?", a.film)}
          ${line("âœ¨ Was wÃ¼nschst du dir fÃ¼r die Menschen, die dieses Buch lesen?", a.wunsch)}

          ${socialHtml}

          ${renderChoices(a)}

          ${a.emoji ? `
            <div class="q">ğŸ˜„ Emoji (deine Stimmung)</div>
            <div class="a">${esc(a.emoji)}</div>
          ` : ""}

          ${d.imageUrl ? `<img src="${esc(d.imageUrl)}" alt="Foto">` : ""}

          <div class="q">ğŸ•’ Zeit</div>
          <div class="a">${esc(formatDate(d.created))}</div>

          ${(d.allowLikes || d.allowComments) ? `
            <div class="actions">
              ${d.allowLikes ? `
                <button class="miniBtn likeBtn" data-id="${esc(d.id)}">
                  â¤ï¸ GefÃ¤llt mir (<span id="lc_${esc(d.id)}">${likesCount}</span>)
                </button>
              ` : ""}
              
              ${isAdminUser() ? `
<button class="miniBtn editBtn" data-id="${esc(d.id)}">âœï¸ Bearbeiten</button>
` : ""}

              ${d.allowComments ? `
                <button class="miniBtn cBtn" data-id="${esc(d.id)}">ğŸ’¬ Kommentare</button>
              ` : ""}
            </div>

            ${d.allowComments ? `
              <div class="comments" id="com_${esc(d.id)}" style="display:none;">
                <div class="comList" id="comList_${esc(d.id)}"></div>
                <div class="comForm">
                  <input maxlength="40" id="comName_${esc(d.id)}" placeholder="Dein Name">
                  <input maxlength="300" id="comInput_${esc(d.id)}" placeholder="Kommentar schreibenâ€¦">
                  <button class="sendCom miniBtn" data-id="${esc(d.id)}">Senden</button>
                </div>
              </div>
            ` : ""}
          ` : ""}
        </div>
      `;
    }).join("");
  }

// =========================
// âœ… Admin Edit (nur Admin)
// =========================
const editOverlay = document.getElementById("editOverlay");
const editName = document.getElementById("editName");
const editJson = document.getElementById("editJson");
const editDurWrap = document.getElementById("editDurWrap");
const editDauerT = document.getElementById("editDauerT");
const editDauerM = document.getElementById("editDauerM");
const editCancel = document.getElementById("editCancel");
const editSave = document.getElementById("editSave");
const editMsg = document.getElementById("editMsg");

let editEntryId = null;
let editOriginalAnswers = null;

const DAUER_OPTIONS = [
  "",
  "Erst heute",
  "Ein paar Wochen",
  "Ein paar Monate",
  "1â€“2 Jahre",
  "3â€“5 Jahre",
  "5â€“10 Jahre",
  "10â€“15 Jahre",
  "15â€“20 Jahre",
  "20+ Jahre"
];

function fillSelect(sel, value) {
  sel.innerHTML = "";
  DAUER_OPTIONS.forEach(opt => {
    const o = document.createElement("option");
    o.value = opt;
    o.textContent = opt || "(freiwillig) auswÃ¤hlenâ€¦";
    sel.appendChild(o);
  });
  sel.value = value || "";
}

function showEdit(msg, ok) {
  editMsg.style.display = "block";
  editMsg.style.color = ok ? "#34d399" : "#fb7185";
  editMsg.textContent = msg;
}

function openEditOverlay() {
  editOverlay.style.display = "flex";
  editMsg.style.display = "none";
}

function closeEditOverlay() {
  editOverlay.style.display = "none";
  editEntryId = null;
  editOriginalAnswers = null;
}

async function openEdit(entryId) {
  if (!isAdminUser()) {
    alert("Nur Admin kann bearbeiten.");
    return;
  }
  
  editEntryId = entryId;
  showEdit("â³ Lade Eintragâ€¦", true);
  openEditOverlay();
  
  const snap = await db.collection("entries").doc(entryId).get();
  if (!snap.exists) {
    closeEditOverlay();
    alert("Eintrag nicht gefunden.");
    return;
  }
  
  const doc = snap.data() || {};
  const answers = doc.answers || {};
  
  editOriginalAnswers = answers;
  
  // Name: aus answers.name
  editName.value = answers.name || "";
  
  // JSON: komplette Antworten
  editJson.value = JSON.stringify(answers, null, 2);
  
  // Dauer-Selects nur zeigen, wenn Struktur da ist
  const hasT = !!answers.t;
  const hasM = !!answers.m;
  
  if (hasT || hasM) {
    editDurWrap.style.display = "block";
    fillSelect(editDauerT, answers?.t?.dauer || "");
    fillSelect(editDauerM, answers?.m?.dauer || "");
  } else {
    editDurWrap.style.display = "none";
  }
  
  editMsg.style.display = "none";
}

async function saveEdit() {
  if (!isAdminUser()) {
    alert("Nur Admin kann speichern.");
    return;
  }
  if (!editEntryId) return;
  
  editSave.disabled = true;
  showEdit("â³ Speichereâ€¦", true);
  
  // 1) JSON parse
  let newAnswers;
  try {
    newAnswers = JSON.parse(editJson.value || "{}");
  } catch (e) {
    editSave.disabled = false;
    showEdit("âŒ JSON ist ungÃ¼ltig.", false);
    return;
  }
  
  // 2) Name aus Input Ã¼berschreibt (safer)
  newAnswers.name = (editName.value || "").trim();
  
  // 3) Dauer Ã¼berschreiben, falls vorhanden
  if (newAnswers.t) {
    newAnswers.t.dauer = editDauerT?.value || "";
  }
  if (newAnswers.m) {
    newAnswers.m.dauer = editDauerM?.value || "";
  }
  
  try {
    await db.collection("entries").doc(editEntryId).update({
      answers: newAnswers,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    showEdit("âœ… Gespeichert.", true);
    
    // UI refresh
    await loadEntries();
    setTimeout(closeEditOverlay, 350);
  } catch (e) {
    showEdit("âŒ Fehler: " + (e?.message || e), false);
  } finally {
    editSave.disabled = false;
  }
}

// Buttons
if (editCancel) editCancel.addEventListener("click", closeEditOverlay);
if (editOverlay) editOverlay.addEventListener("click", (e) => {
  if (e.target === editOverlay) closeEditOverlay();
});
if (editSave) editSave.addEventListener("click", saveEdit);

// Klick auf âœï¸ Bearbeiten (delegiert)
document.addEventListener("click", (e) => {
  const b = e.target.closest(".editBtn");
  if (b) openEdit(b.dataset.id);
});

  loadEntries();
  
  // =========================
// ğŸ¯ Community-Auswertung
// =========================
const gameStatsEl = document.getElementById("gameStats");

// Labels + Feldnamen (passen zu deinen IDs a1..a5)
const GAME_QUESTIONS = [
  { key: "a1", label: "ğŸ¥™ DÃ¶ner oder Pizza?" },
  { key: "a2", label: "ğŸº Bier oder Wein?" },
  { key: "a3", label: "ğŸ“º Netflix oder Disney+?" },
  { key: "a4", label: "â° FrÃ¼haufsteher oder LangschlÃ¤fer?" },
  { key: "a5", label: "ğŸ”€ Planen oder spontan?" },
];

function renderGameStats(stats) {
  if (!gameStatsEl) return;
  
  // Wenn gar nichts vorhanden
  const hasAny = GAME_QUESTIONS.some(q => stats[q.key] && Object.keys(stats[q.key]).length);
  if (!hasAny) {
    gameStatsEl.innerHTML = `<div class="muted">Noch keine Auswahlspiel-Antworten vorhanden.</div>`;
    return;
  }
  
  const CLOSE_DIFF_PCT = 5; // âœ… "Knappes Rennen" nur wenn Top1 & Top2 <= 5% auseinander
  
  gameStatsEl.innerHTML = GAME_QUESTIONS.map(q => {
    const counts = stats[q.key] || {};
    
    // entries: [ [val,count], ... ]
    const entries = Object.entries(counts)
      .filter(([val, n]) => val && Number(n) > 0)
      .map(([val, n]) => [val, Number(n)])
      .sort((a, b) => b[1] - a[1]);
    
    if (!entries.length) return "";
    
    const total = entries.reduce((sum, [, n]) => sum + n, 0);
    
    // âœ… Top Counts / Prozent
    const topCount = entries[0]?.[1] || 0;
    const top2Count = entries[1]?.[1] || 0;
    
    const topPct = total ? (topCount / total) * 100 : 0;
    const top2Pct = total ? (top2Count / total) * 100 : 0;
    
    // âœ… Mehrere Sieger, wenn gleicher Count wie Platz 1
    const winners = entries
      .filter(([, n]) => n === topCount)
      .map(([val]) => val);
    
    // âœ… Knappes Rennen:
    // - Es gibt Platz 2
    // - Top1 und Top2 max 5% auseinander
    // - UND: kein Gleichstand um Platz 1 (wenn Gleichstand -> wir zeigen lieber "Sieger: A & B")
    const isClose =
  entries.length >= 2 &&
  winners.length === 1 &&
  (
    (topPct - top2Pct) <= CLOSE_DIFF_PCT ||
    (topCount - top2Count) <= 1
  );
    
    // âœ… Anzeige: "Gewinner" vs "Sieger"
    const winnerLine =
      winners.length === 1 ?
      `ğŸ† Gewinner: ${esc(winners[0])}` :
      `ğŸ† Sieger: ${winners.map(esc).join(" & ")}`;
    
    const winnerPctRounded = total ? Math.round(topPct) : 0;
    
    // âœ… Details: alle Optionen in einer Zeile, kurz
    const details = entries
      .map(([val, n]) => {
        const pct = total ? Math.round((n / total) * 100) : 0;
        return `${esc(val)}: ${n} (${pct}%)`;
      })
      .join(" Â· ");
    
    return `
      <div style="
        margin-top:14px;
        padding:12px 14px;
        border-radius:16px;
        border:1px solid rgba(255,255,255,.12);
        background:rgba(255,255,255,.06);
      ">
        <div class="q">${esc(q.label)}</div>

        <div style="font-weight:900;margin-top:6px">
          ${winnerLine}
          <span class="muted">Â· ${topCount} (${winnerPctRounded}%)</span>
        </div>

        ${isClose ? `
          <div style="
            margin-top:4px;
            font-size:13px;
            font-weight:800;
            color:#fbbf24;
          ">
            ğŸ”¥ Knappes Rennen
          </div>
        ` : ""}

        <div style="margin-top:8px;font-size:13px;color:#94a3b8">
          ${details}
        </div>
      </div>
    `;
  }).join("");
}

async function loadGameStats() {
  if (!gameStatsEl) return;
  gameStatsEl.innerHTML = `<div class="muted">â³ Auswertung wird geladenâ€¦</div>`;
  
  try {
    const snap = await db.collection("entries")
      .where("type", "==", "freundebuch")
      .limit(500)
      .get();
    
    // stats[a1][value] = count
    const stats = {};
    GAME_QUESTIONS.forEach(q => stats[q.key] = {});
    
    snap.docs.forEach(doc => {
      const d = doc.data() || {};
      const a = d.answers || {};
      
      GAME_QUESTIONS.forEach(q => {
        const v = (a[q.key] || "").trim();
        if (!v) return;
        stats[q.key][v] = (stats[q.key][v] || 0) + 1;
      });
    });
    
    renderGameStats(stats);
  } catch (e) {
    console.warn("GameStats load error:", e);
    gameStatsEl.innerHTML = `<div class="muted">âŒ Konnte Auswertung nicht laden.</div>`;
  }
}

// Beim Laden einmal ausfÃ¼hren
loadGameStats();
  
</script>

<script>
(function(){
  const CORRECT = "1234";
  const KEY = "fb_unlocked";

  const overlay = document.getElementById("lockOverlay");
  const input = document.getElementById("pwInput");
  const btn = document.getElementById("pwBtn");
  const msg = document.getElementById("pwMsg");

  function showLock(){
    overlay.style.display = "flex";
    msg.style.display = "none";
    input.value = "";
    setTimeout(()=>input.focus(), 50);
  }
  function hideLock(){
    overlay.style.display = "none";
    msg.style.display = "none";
  }

  // Wenn nicht freigeschaltet â†’ sperren
  if(localStorage.getItem(KEY) === "1"){
    hideLock();
  } else {
    showLock();
  }

  function unlock(){
    const val = (input.value || "").trim();
    if(val === CORRECT){
      localStorage.setItem(KEY, "1");
      hideLock();
    } else {
      msg.style.display = "block";
      input.value = "";
      input.focus();
    }
  }

  btn.addEventListener("click", unlock);
  input.addEventListener("keydown", (e) => {
    if(e.key === "Enter") unlock();
  });
})();
</script>


</div>

</body>
</html>