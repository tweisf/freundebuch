<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GÃ¤stebuch</title>
  <link rel="stylesheet" href="styles.css">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="bg"></div>

  <main class="shell">
    <header class="hero">
      <div class="badge">ğŸ“</div>
      <div>
        <h1>GÃ¤stebuch</h1>
        <p class="muted">Kurz & easy â€“ mit Anlass, Emoji und optional Foto.</p>
      </div>
    </header>

    <section class="card">
      <div class="label">Name *</div>
      <input class="input" id="name" placeholder="Wie heiÃŸt du?" />

      <div class="label">Anlass â€“ warum bist du hier? *</div>
      <input class="input" id="anlass" placeholder="z.B. Geburtstag, Dinner, Feier, randomâ€¦" />

      <div class="label">Kurzer Eintrag *</div>
      <textarea class="input" id="text" placeholder="Ein Satz reicht ğŸ™‚"></textarea>

      <div class="row two">
        <div>
          <div class="label">Emoji *</div>
          <select class="input" id="emoji">
            <option value="">Bitte wÃ¤hlenâ€¦</option>
            <option>ğŸ˜„</option><option>ğŸ¥³</option><option>ğŸ«¶</option><option>ğŸ˜</option><option>ğŸ”¥</option><option>ğŸ¤</option>
          </select>
        </div>
        <div>
          <div class="label">Lieblingsdrink *</div>
          <input class="input" id="drink" placeholder="z.B. Aperol, Bier, Colaâ€¦" />
        </div>
      </div>

      <div class="label">Foto (optional)</div>
      <input class="input" type="file" id="image" accept="image/*" capture="environment"/>

      <div class="row two">
        <div>
          <div class="label">Likes erlauben?</div>
          <select class="input" id="allowLikes"><option value="yes" selected>Ja</option><option value="no">Nein</option></select>
        </div>
        <div>
          <div class="label">Kommentare erlauben?</div>
          <select class="input" id="allowComments"><option value="yes" selected>Ja</option><option value="no">Nein</option></select>
        </div>
      </div>

      <button class="primary" id="saveBtn">Eintrag speichern</button>
      <div class="notice" id="status"></div>
    </section>

    <section class="card" style="margin-top:14px;">
      <div class="entriesHeader">
        <h2>ğŸ“Œ GÃ¤stebuch-EintrÃ¤ge</h2>
        <button class="actionBtn" id="reloadBtn">Neu laden</button>
      </div>
      <p class="muted tiny">Neueste zuerst.</p>
      <div id="entries"></div>
    </section>
  </main>

  <a class="adminFab" href="admin.html" title="Admin">ğŸ”’</a>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCLnz3t9VcQJLg2oqbZd2cA7-hXF30UyHM",
    authDomain: "freundebuch-neu.firebaseapp.com",
    projectId: "freundebuch-neu",
    storageBucket: "freundebuch-neu.firebasestorage.app",
    messagingSenderId: "732597691942",
    appId: "1:732597691942:web:2c116f530c4179d1c2a8e7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  const esc = (s) => String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  function getLocalUid(){
    let uid = localStorage.getItem("fb_uid");
    if(!uid){
      uid = "u_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
      localStorage.setItem("fb_uid", uid);
    }
    return uid;
  }

  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString("de-DE", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch(e){ return ""; }
  }

  async function uploadImage(file){
    const ref = storage.ref("uploads/" + Date.now() + "_" + file.name.replaceAll(" ", "_"));
    await ref.put(file);
    return await ref.getDownloadURL();
  }

  const statusEl = document.getElementById("status");
  const entriesEl = document.getElementById("entries");

  async function saveEntry(){
    statusEl.innerHTML = "";
    const name = document.getElementById("name").value.trim();
    const anlass = document.getElementById("anlass").value.trim();
    const text = document.getElementById("text").value.trim();
    const emoji = document.getElementById("emoji").value;
    const drink = document.getElementById("drink").value.trim();

    const missing = [];
    if(!name) missing.push("Name");
    if(!anlass) missing.push("Anlass");
    if(!text) missing.push("Eintrag");
    if(!emoji) missing.push("Emoji");
    if(!drink) missing.push("Lieblingsdrink");

    if(missing.length){
      statusEl.innerHTML = `<div class="error">Bitte ausfÃ¼llen: ${esc(missing.join(", "))}</div>`;
      return;
    }

    const file = document.getElementById("image").files[0];
    let imageUrl = "";
    if(file){
      statusEl.innerHTML = `<div class="muted">Bild wird hochgeladenâ€¦</div>`;
      imageUrl = await uploadImage(file);
    }

    await db.collection("entries").add({
      type: "gaestebuch",
      name,
      allowLikes: document.getElementById("allowLikes").value === "yes",
      allowComments: document.getElementById("allowComments").value === "yes",
      imageUrl,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      clientUid: getLocalUid(),
      likesCount: 0,
      answers: { anlass, text, emoji, drink }
    });

    statusEl.innerHTML = `<div class="success">âœ… Gespeichert!</div>`;
    await loadEntries();
  }

  async function loadEntries(){
    entriesEl.innerHTML = `<div class="muted">Lade EintrÃ¤geâ€¦</div>`;
    const snap = await db.collection("entries")
      .where("type","==","gaestebuch")
      .orderBy("createdAt","desc")
      .limit(30)
      .get();

    if(snap.empty){
      entriesEl.innerHTML = `<div class="muted">Noch keine EintrÃ¤ge.</div>`;
      return;
    }

    const cards = snap.docs.map(d=>{
      const data = d.data();
      return `
        <article class="entry">
          <div class="entryTop">
            <div>
              <div class="entryName">${esc(data.name || "Unbekannt")}</div>
              <div class="entryMeta">ğŸ•’ ${esc(fmtDate(data.createdAt))}</div>
            </div>
            <div class="tag">ğŸ“ GÃ¤stebuch</div>
          </div>
          <div class="entryBody">
            ${data.imageUrl ? `<div class="photo"><img src="${esc(data.imageUrl)}" alt="Foto"></div>` : ""}

            <div class="qa">
              <div><div class="q">Anlass â€“ warum bist du hier?</div><div class="a">${esc(data.answers?.anlass)}</div></div>
              <div><div class="q">Dein Eintrag</div><div class="a">${esc(data.answers?.text)}</div></div>
              <div><div class="q">Emoji</div><div class="a">${esc(data.answers?.emoji)}</div></div>
              <div><div class="q">Lieblingsdrink</div><div class="a">${esc(data.answers?.drink)}</div></div>
            </div>
          </div>
        </article>
      `;
    });

    entriesEl.innerHTML = cards.join("");
  }

  document.getElementById("saveBtn").addEventListener("click", saveEntry);
  document.getElementById("reloadBtn").addEventListener("click", loadEntries);
  loadEntries();
</script>
</body>
</html>