<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>G√§stebuch</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#0f172a;color:#f8fafc}
  main{max-width:820px;margin:auto;padding:20px}
  .card{background:#020617;border:1px solid #1e293b;border-radius:16px;padding:16px;margin-bottom:16px}
  h1,h2{margin:0 0 10px}
  label{font-size:13px;color:#94a3b8}
  input,select,textarea,button{
    width:100%;padding:12px;margin-top:6px;margin-bottom:12px;border-radius:12px;
    border:1px solid #334155;background:#020617;color:#f8fafc
  }
  textarea{min-height:80px;resize:vertical}
  button{background:linear-gradient(135deg,#34d399,#60a5fa);border:none;font-weight:800;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .entry{border:1px solid #1e293b;border-radius:16px;padding:14px;margin-top:14px;background:#020617}
  .entry h3{margin:0}
  .q{color:#94a3b8;font-size:13px;margin-top:10px}
  .a{margin-top:4px;white-space:pre-wrap}
  img{width:100%;border-radius:14px;margin-top:10px}
  hr{border:none;border-top:1px solid #1e293b;margin:14px 0}
  .status{margin-top:10px;font-weight:800}
  .ok{color:#34d399}
  .err{color:#fb7185}

  /* Back + Admin dot */
  .backLink{
    position:fixed;top:12px;left:12px;font-size:13px;color:#94a3b8;text-decoration:none;
    padding:6px 8px;border-radius:8px;background:rgba(2,6,23,.6);
    border:1px solid #1e293b;z-index:1000
  }
  .backLink:hover{color:#e5e7eb;border-color:#334155}
  .adminDot{
    position:fixed;right:10px;bottom:10px;width:12px;height:12px;border-radius:50%;
    background:#334155;opacity:.5;z-index:1000
  }
  .adminDot:hover{opacity:1;background:#64748b}

  /* Likes + Kommentare */
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .miniBtn{
    width:auto;padding:10px 12px;margin:0;border-radius:12px;
    border:1px solid rgba(255,255,255,.15);
    background:rgba(255,255,255,.06);
    color:#fff;font-weight:700;cursor:pointer
  }
  .miniBtn:disabled{opacity:.5;cursor:not-allowed}
  .comments{margin-top:12px;padding:12px;border-radius:14px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08)}
  .comItem{padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08)}
  .comItem:last-child{border-bottom:none}
  .muted{color:#94a3b8;font-size:13px}

  /* Kommentar: Name + Kommentar + Admin l√∂schen */
  .comHeader{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
  .comName{font-weight:900}
  .delCom{
    border:none;
    background:transparent;
    color:#fb7185;
    cursor:pointer;
    font-weight:900;
    padding:6px 8px;
    border-radius:10px;
    width:auto;
  }
  .delCom:hover{background:rgba(251,113,133,.12)}

  /* Kommentar-Form mit 2 Inputs */
  .comForm{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
  .comForm input{margin:0}
  .comForm input:first-child{flex:0 0 160px;min-width:140px}
  .comForm input:nth-child(2){flex:1;min-width:160px}
  .comForm button{width:auto;margin:0;padding:10px 14px;border-radius:12px}
</style>
</head>

<body>
<a href="index.html" class="backLink">‚Üê zur√ºck</a>
<a href="admin.html" class="adminDot" title="Admin"></a>

<main>

<h1>üìù G√§stebuch</h1>

<div class="card">
  <label>Dein Name (oder Spitzname) *</label>
  <input id="gb_name" placeholder="z.B. Alex">

  <label>Datum & Uhrzeit</label>
  <input id="gb_time" disabled>

  <label>Anlass ‚Äì warum bist du heute hier? *</label>
  <input id="gb_anlass" placeholder="z.B. Geburtstag, Dinner, Feier, Besuch...">

  <label>Wie war‚Äôs heute? (Emoji) *</label>
  <select id="gb_emoji">
    <option value="">Bitte w√§hlen‚Ä¶</option>
    <option>ü•≥</option><option>üòÑ</option><option>üôÇ</option><option>üòé</option>
    <option>üî•</option><option>ü´∂</option><option>üçª</option><option>‚ú®</option>
    <option>üò¥</option><option>ü§Ø</option>
  </select>

  <label>Dein Highlight heute *</label>
  <input id="gb_highlight" placeholder="z.B. Moment, Song, Gespr√§ch...">

  <label>Lieblingsdrink (generell) *</label>
  <input id="gb_drink" placeholder="z.B. Aperol, Bier, Wasser, Cola...">

  <label>Freier Eintrag (optional)</label>
  <textarea id="gb_text" placeholder="Wenn du willst üôÇ"></textarea>

  <label>Foto (optional)</label>
  <input type="file" id="gb_image" accept="image/*">

  <!-- Likes/Kommentare erlauben -->
  <label style="display:flex; gap:10px; align-items:center; margin:6px 0 0;">
    <input type="checkbox" id="allowLikes" checked style="width:auto;margin:0">
    Likes erlauben
  </label>

  <label style="display:flex; gap:10px; align-items:center; margin:8px 0 12px;">
    <input type="checkbox" id="allowComments" checked style="width:auto;margin:0">
    Kommentare erlauben
  </label>

  <button id="saveBtn" onclick="saveEntry()">Eintrag speichern</button>
  <div class="status" id="status"></div>
</div>

<h2>üìå Eintr√§ge</h2>
<div class="muted">Neueste zuerst.</div>
<div id="entries"></div>

</main>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCLnz3t9VcQJLg2oqbZd2cA7-hXF30UyHM",
    authDomain: "freundebuch-neu.firebaseapp.com",
    projectId: "freundebuch-neu",
    storageBucket: "freundebuch-neu.firebasestorage.app",
    messagingSenderId: "732597691942",
    appId: "1:732597691942:web:2c116f530c4179d1c2a8e7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();
  const auth = firebase.auth();

  const ADMIN_EMAIL = "male01.w@gmail.com";
  function isAdminUser(){
    const u = auth.currentUser;
    return !!u && (u.email || "").toLowerCase() === ADMIN_EMAIL.toLowerCase();
  }

  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const entriesEl = $("entries");
  const saveBtn = $("saveBtn");

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function nowDE(){
    return new Date().toLocaleString("de-DE");
  }

  // Anonymous Login (f√ºr Likes/Kommentare)
  auth.onAuthStateChanged(async (user) => {
    if(!user){
      try { await auth.signInAnonymously(); } catch(e){}
    }
  });

  async function uploadImage(file){
    const safeName = (file.name || "bild").replace(/\s+/g, "_");
    const ref = storage.ref("uploads/" + Date.now() + "_" + safeName);
    await ref.put(file);
    return await ref.getDownloadURL();
  }

  async function saveEntry(){
    statusEl.className = "status";
    statusEl.textContent = "";

    const data = {
      name: $("gb_name").value.trim(),
      time: nowDE(),
      anlass: $("gb_anlass").value.trim(),
      emoji: $("gb_emoji").value,
      highlight: $("gb_highlight").value.trim(),
      drink: $("gb_drink").value.trim(),
      text: $("gb_text").value.trim()
    };

    const requiredKeys = ["name","anlass","emoji","highlight","drink"];
    const missing = requiredKeys.filter(k => !data[k]);
    if(missing.length){
      statusEl.classList.add("err");
      statusEl.textContent = "‚ùå Bitte alle Pflichtfelder ausf√ºllen.";
      return;
    }

    saveBtn.disabled = true;
    statusEl.textContent = "‚è≥ Speichern‚Ä¶";

    try{
      const file = $("gb_image").files[0];
      let imageUrl = "";
      if(file){
        statusEl.textContent = "‚è≥ Bild hochladen‚Ä¶";
        imageUrl = await uploadImage(file);
      }

      await db.collection("entries").add({
        type: "gaestebuch",
        created: firebase.firestore.FieldValue.serverTimestamp(),
        imageUrl,
        answers: data,

        allowLikes: $("allowLikes").checked,
        allowComments: $("allowComments").checked,
        likesCount: 0
      });

      statusEl.classList.add("ok");
      statusEl.textContent = "‚úÖ Gespeichert!";
      await loadEntries();

    }catch(e){
      statusEl.classList.add("err");
      statusEl.textContent = "‚ùå Fehler: " + (e?.message || e);
    }finally{
      saveBtn.disabled = false;
    }
  }

  function formatDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : new Date();
      return d.toLocaleString("de-DE");
    }catch{ return ""; }
  }

  // ===== Likes + Kommentare =====
  async function ensureAnon(){
    if(!auth.currentUser){
      try { await auth.signInAnonymously(); } catch(e){}
    }
  }

  async function toggleLike(entryId){
    await ensureAnon();
    const user = auth.currentUser;
    if(!user) return;

    const entryRef = db.collection("entries").doc(entryId);
    const likeRef = entryRef.collection("likes").doc(user.uid);
    const likeSnap = await likeRef.get();

    await db.runTransaction(async (tx) => {
      const entrySnap = await tx.get(entryRef);
      const allowLikes = entrySnap.data()?.allowLikes;
      if(!allowLikes) return;

      const likesCount = entrySnap.data()?.likesCount || 0;

      if(likeSnap.exists){
        tx.delete(likeRef);
        tx.update(entryRef, { likesCount: Math.max(0, likesCount - 1) });
      } else {
        tx.set(likeRef, { created: firebase.firestore.FieldValue.serverTimestamp() });
        tx.update(entryRef, { likesCount: likesCount + 1 });
      }
    });

    const lc = document.getElementById("lc_" + entryId);
    if(lc){
      const snap = await entryRef.get();
      lc.textContent = String(snap.data()?.likesCount || 0);
    }
  }

  function toggleComments(entryId){
    const box = document.getElementById("com_" + entryId);
    if(!box) return;
    const isOpen = box.style.display !== "none";
    box.style.display = isOpen ? "none" : "block";
    if(!isOpen) startCommentsStream(entryId);
  }

  const commentUnsubs = new Map();
  function startCommentsStream(entryId){
    if(commentUnsubs.has(entryId)) return;

    const list = document.getElementById("comList_" + entryId);
    if(!list) return;

    const unsub = db.collection("entries").doc(entryId)
      .collection("comments")
      .orderBy("created","asc")
      .limit(50)
      .onSnapshot((qs) => {
        list.innerHTML = "";
        if(qs.empty){
          list.innerHTML = "<div class='muted'>Noch keine Kommentare.</div>";
          return;
        }

        const admin = isAdminUser();

        qs.forEach((doc) => {
          const c = doc.data() || {};
          const cid = doc.id;
          list.innerHTML += `
            <div class="comItem">
              <div class="comHeader">
                <div><span class="comName">${esc(c.name || "Anonym")}</span>: ${esc(c.text || "")}</div>
                ${admin ? `<button class="delCom" data-entry="${esc(entryId)}" data-cid="${esc(cid)}">L√∂schen</button>` : ""}
              </div>
            </div>
          `;
        });
      });

    commentUnsubs.set(entryId, unsub);
  }

  async function sendComment(entryId){
    await ensureAnon();
    const user = auth.currentUser;
    if(!user) return;

    const nameEl = document.getElementById("comName_" + entryId);
    const inputEl = document.getElementById("comInput_" + entryId);

    const name = (nameEl?.value || "").trim();
    const text = (inputEl?.value || "").trim();

    if(!name){
      alert("Bitte Name eingeben üôÇ");
      return;
    }
    if(!text) return;

    await db.collection("entries").doc(entryId).collection("comments").add({
      uid: user.uid,
      name,
      text,
      created: firebase.firestore.FieldValue.serverTimestamp()
    });

    inputEl.value = "";
  }

  async function deleteComment(entryId, commentId){
    if(!isAdminUser()){
      alert("Nur Admin kann l√∂schen.");
      return;
    }
    if(!confirm("Kommentar wirklich l√∂schen?")) return;

    await db.collection("entries").doc(entryId)
      .collection("comments").doc(commentId)
      .delete();
  }

  document.addEventListener("click", (e) => {
    const likeBtn = e.target.closest(".likeBtn");
    const cBtn = e.target.closest(".cBtn");
    const sendBtn = e.target.closest(".sendCom");
    const delBtn = e.target.closest(".delCom");

    if(likeBtn) toggleLike(likeBtn.dataset.id);
    if(cBtn) toggleComments(cBtn.dataset.id);
    if(sendBtn) sendComment(sendBtn.dataset.id);
    if(delBtn) deleteComment(delBtn.dataset.entry, delBtn.dataset.cid);
  });

  // ===== Laden/Render =====
  async function loadEntries(){
    entriesEl.textContent = "‚è≥ Lade‚Ä¶";

    const snap = await db.collection("entries")
      .orderBy("created","desc")
      .limit(150)
      .get();

    const docs = snap.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(d => d.type === "gaestebuch");

    if(!docs.length){
      entriesEl.innerHTML = "<div style='color:#94a3b8'>Noch keine Eintr√§ge.</div>";
      return;
    }

    entriesEl.innerHTML = docs.map(d => {
      const a = d.answers || {};
      const likesCount = d.likesCount || 0;

      return `
        <div class="entry">
          <h3>${esc(a.name || "Unbekannt")}</h3>

          <div class="q">Datum & Uhrzeit</div>
          <div class="a">${esc(formatDate(d.created) || a.time)}</div>

          <div class="q">Anlass ‚Äì warum bist du heute hier?</div>
          <div class="a">${esc(a.anlass)}</div>

          <div class="q">Wie war‚Äôs heute? (Emoji)</div>
          <div class="a">${esc(a.emoji)}</div>

          <div class="q">Dein Highlight heute</div>
          <div class="a">${esc(a.highlight)}</div>

          <div class="q">Lieblingsdrink (generell)</div>
          <div class="a">${esc(a.drink)}</div>

          ${a.text ? `
            <div class="q">Freier Eintrag</div>
            <div class="a">${esc(a.text)}</div>
          ` : ""}

          ${d.imageUrl ? `<img src="${esc(d.imageUrl)}" alt="Foto">` : ""}

          ${(d.allowLikes || d.allowComments) ? `
            <div class="actions">
              ${d.allowLikes ? `
                <button class="miniBtn likeBtn" data-id="${esc(d.id)}">
                  ‚ù§Ô∏è Gef√§llt mir (<span id="lc_${esc(d.id)}">${likesCount}</span>)
                </button>
              ` : ""}

              ${d.allowComments ? `
                <button class="miniBtn cBtn" data-id="${esc(d.id)}">üí¨ Kommentare</button>
              ` : ""}
            </div>

            ${d.allowComments ? `
              <div class="comments" id="com_${esc(d.id)}" style="display:none;">
                <div class="comList" id="comList_${esc(d.id)}"></div>
                <div class="comForm">
                  <input maxlength="40" id="comName_${esc(d.id)}" placeholder="Dein Name">
                  <input maxlength="300" id="comInput_${esc(d.id)}" placeholder="Kommentar schreiben‚Ä¶">
                  <button class="sendCom miniBtn" data-id="${esc(d.id)}">Senden</button>
                </div>
              </div>
            ` : ""}
          ` : ""}
        </div>
      `;
    }).join("");
  }

  $("gb_time").value = nowDE();
  loadEntries();
</script>
</body>
</html>