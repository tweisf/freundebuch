<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìò Freundebuch / G√§stebuch</title>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    :root{
      --bg1:#0b1020; --bg2:#111a33;
      --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --accent:#7c3aed; --accent2:#06b6d4;
      --danger:#ef4444; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 10%, #1b2a66 0%, transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, #4c1d95 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      color:#eef2ff;
      min-height:100vh;
      padding:20px 14px 90px;
    }
    .wrap{max-width:980px;margin:0 auto;}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:14px;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:46px;height:46px;border-radius:14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display:grid; place-items:center;
      box-shadow: 0 12px 30px rgba(124,58,237,.35);
      font-weight:900;
    }
    h1{margin:0; font-size:22px; line-height:1.1}
    .sub{margin:4px 0 0; color:#aab3d6; font-size:13px}

    .nav{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .btn{
      border:none; cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      color:white;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 26px rgba(124,58,237,.25);
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }
    @media (max-width:900px){ .grid{grid-template-columns:1fr;} }

    .card{
      background: rgba(255,255,255,.92);
      color:var(--text);
      border: 1px solid rgba(255,255,255,.35);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .muted{color:var(--muted); font-size:13px}
    .hr{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(15,23,42,.2), transparent);
      margin:14px 0;
    }

    label{display:block; margin:10px 0 6px; font-size:13px; color:var(--muted); font-weight:700}
    input, textarea, select{
      width:100%;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-size:15px;
    }
    textarea{min-height:92px; resize:vertical}
    input[type="file"]{padding:10px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:520px){ .row{grid-template-columns:1fr;} }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(15,23,42,.12);
      padding:8px 10px; border-radius:999px;
      color:#334155; font-size:12px;
      background: rgba(255,255,255,.65);
      font-weight:700;
    }

    .saveBtn{
      width:100%;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:15px;
      cursor:pointer;
      color:white;
      background: linear-gradient(135deg, #111827, #334155);
      margin-top:10px;
    }
    .saveBtn:disabled{opacity:.6; cursor:not-allowed}

    .status{margin-top:10px; font-weight:900; color:#065f46}

    /* Entries */
    .entry{
      border:1px solid rgba(15,23,42,.12);
      border-radius:16px;
      padding:12px;
      background: rgba(255,255,255,.72);
      margin:12px 0;
    }
    .entryHead{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      align-items:flex-start;
    }
    .entryName{font-weight:900; font-size:16px; margin:0}
    .entryMeta{font-size:12px; color:var(--muted)}
    .entryImg{
      width:120px; height:120px; object-fit:cover;
      border-radius:14px; border:1px solid rgba(15,23,42,.12);
      background:#fff;
    }
    .entryGrid{display:grid; grid-template-columns:130px 1fr; gap:12px}
    @media (max-width:520px){ .entryGrid{grid-template-columns:1fr;} .entryImg{width:100%; height:auto;} }
    .qa{display:grid; gap:8px; margin-top:8px}
    .q{font-size:12px; color:var(--muted); font-weight:800}
    .a{font-size:14px; color:#0f172a; white-space:pre-wrap}

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .likeBtn{
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      padding:9px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .dangerBtn{
      border-radius:999px;
      border:none;
      background: var(--danger);
      color:#fff;
      padding:9px 12px;
      font-weight:900;
      cursor:pointer;
    }

    /* Admin floating */
    .adminFloat{
      position:fixed;
      right:14px;
      bottom:14px;
      width:min(360px, calc(100vw - 28px));
      background: rgba(255,255,255,.92);
      color:var(--text);
      border:1px solid rgba(255,255,255,.35);
      border-radius:18px;
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      overflow:hidden;
      backdrop-filter: blur(8px);
    }
    .adminHead{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px;
      background: rgba(15,23,42,.06);
      font-weight:900;
    }
    .adminBody{padding:12px; display:none}
    .adminBody.show{display:block}
    .tiny{font-size:12px; color:var(--muted); margin-top:6px}
    .miniRow{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .miniBtn{width:100%; border:none; border-radius:12px; padding:10px; font-weight:900; cursor:pointer;}
    .miniBtn.dark{background:#111827;color:#fff}
    .miniBtn.light{background:#fff;border:1px solid rgba(15,23,42,.12); color:#111827}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">üìò</div>
      <div>
        <h1>Willkommen</h1>
        <div class="sub">W√§hle: G√§stebuch oder Freundebuch</div>
      </div>
    </div>

    <div class="nav">
      <button class="btn secondary" onclick="go('#/')">Start</button>
      <button class="btn secondary" onclick="go('#/gaestebuch')">G√§stebuch</button>
      <button class="btn secondary" onclick="go('#/freundebuch')">Freundebuch</button>
    </div>
  </div>

  <div id="app"></div>
</div>

<!-- Admin Floating Login (unten rechts) -->
<div class="adminFloat">
  <div class="adminHead">
    <div>üîê Admin</div>
    <button class="btn secondary" style="padding:7px 10px;border-radius:999px" id="adminToggle">√ñffnen</button>
  </div>
  <div class="adminBody" id="adminBody">
    <div class="miniRow">
      <input id="adminEmail" type="email" placeholder="E-Mail" />
      <input id="adminPass" type="password" placeholder="Passwort" />
    </div>
    <div class="miniRow" style="margin-top:10px;">
      <button class="miniBtn dark" id="loginBtn">Login</button>
      <button class="miniBtn light" id="logoutBtn">Logout</button>
    </div>
    <div class="tiny" id="adminStatus">Nicht eingeloggt.</div>
  </div>
</div>

<script>
  // ========= Firebase =========
  const firebaseConfig = {
    apiKey: "AIzaSyCLnz3t9VcQJLg2oqbZd2cA7-hXF30UyHM",
    authDomain: "freundebuch-neu.firebaseapp.com",
    projectId: "freundebuch-neu",
    storageBucket: "freundebuch-neu.firebasestorage.app",
    messagingSenderId: "732597691942",
    appId: "1:732597691942:web:2c116f530c4179d1c2a8e7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();
  const auth = firebase.auth();

  const ADMIN_EMAIL = "male01.w@gmail.com";

  const appEl = document.getElementById("app");
  const esc = (s) => String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  function go(hash){ location.hash = hash; }

  function getLocalUid(){
    let uid = localStorage.getItem("fb_uid");
    if(!uid){
      uid = "u_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
      localStorage.setItem("fb_uid", uid);
    }
    return uid;
  }
  function isAdmin(){
    const u = auth.currentUser;
    return !!u && (u.email || "").toLowerCase() === ADMIN_EMAIL.toLowerCase();
  }
  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
      return d ? d.toLocaleString("de-DE", {dateStyle:"medium", timeStyle:"short"}) : "";
    }catch{ return ""; }
  }

  // ========= Admin floating =========
  const adminToggle = document.getElementById("adminToggle");
  const adminBody = document.getElementById("adminBody");
  const adminStatus = document.getElementById("adminStatus");

  adminToggle.onclick = () => {
    adminBody.classList.toggle("show");
    adminToggle.textContent = adminBody.classList.contains("show") ? "Schlie√üen" : "√ñffnen";
  };

  document.getElementById("loginBtn").onclick = async () => {
    const email = document.getElementById("adminEmail").value.trim();
    const pass  = document.getElementById("adminPass").value.trim();
    try{
      await auth.signInWithEmailAndPassword(email, pass);
    }catch(e){
      adminStatus.textContent = "‚ùå Login: " + (e.message || e);
    }
  };
  document.getElementById("logoutBtn").onclick = async () => { await auth.signOut(); };

  auth.onAuthStateChanged((u)=>{
    if(!u) adminStatus.textContent = "Nicht eingeloggt.";
    else if(isAdmin()) adminStatus.textContent = "‚úÖ Admin: " + u.email;
    else adminStatus.textContent = "‚ö†Ô∏è Eingeloggt (nicht Admin): " + u.email;
    render();
  });

  // ========= Views =========
  function viewHome(){
    return `
      <div class="card">
        <div class="pill">‚ú® Bitte ausw√§hlen</div>
        <div class="hr"></div>
        <p style="margin:0 0 12px 0; font-weight:900; font-size:18px;">Was m√∂chtest du √∂ffnen?</p>
        <div class="row">
          <button class="btn" onclick="go('#/gaestebuch')">üìï G√§stebuch</button>
          <button class="btn" onclick="go('#/freundebuch')">üìò Freundebuch</button>
        </div>
        <div class="hr"></div>
        <div class="muted">
          Tipp: Du kannst den Link auch als QR-Code drucken. NFC bleibt einfach unter dem Blatt.
        </div>
      </div>
    `;
  }

  function commonInteraktionFields(){
    return `
      <label>Gef√§llt mir erlauben?</label>
      <select id="allowLikes">
        <option value="yes">Ja</option>
        <option value="no">Nein</option>
      </select>

      <label>Kommentare erlauben?</label>
      <select id="allowComments">
        <option value="yes">Ja</option>
        <option value="no">Nein</option>
      </select>
    `;
  }

  function photoField(){
    return `
      <label>Foto (optional)</label>
      <input type="file" id="image" accept="image/*" />
      <div class="muted">Optional ‚Äì wenn du willst üôÇ</div>
    `;
  }

  function viewGaestebuch(){
    return `
      <div class="grid">
        <div class="card">
          <div class="pill">üìï G√§stebuch</div>
          <div class="muted" style="margin-top:6px;">Kurz, locker, f√ºr den Moment.</div>
          <div class="hr"></div>

          <label>Name / Spitzname *</label>
          <input id="name" placeholder="z. B. Max" />

          <label>Anlass, warum du hier bist</label>
          <input id="anlass" placeholder="z. B. Geburtstag, Besuch, Feier..." />

          <label>Stimmung</label>
          <select id="mood">
            <option value="ü•≥ mega">ü•≥ mega</option>
            <option value="üòÑ gut">üòÑ gut</option>
            <option value="üôÇ entspannt">üôÇ entspannt</option>
            <option value="üòê geht so">üòê geht so</option>
            <option value="üò¥ m√ºde">üò¥ m√ºde</option>
            <option value="üçª wild">üçª wild</option>
          </select>

          <label>Ein Wort, das den Abend beschreibt</label>
          <input id="abendWort" placeholder="z. B. legend√§r" />

          <label>Ein Satz an mich</label>
          <textarea id="satz" placeholder="Schreib einen Satz..."></textarea>

          <label>Lieblingsdrink</label>
          <input id="drink" placeholder="z. B. Aperol, Bier, Wasser..." />

          ${commonInteraktionFields()}
          ${photoField()}

          <button class="saveBtn" id="saveBtn">Eintrag speichern</button>
          <div class="status" id="status"></div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <div class="pill">üìå G√§stebuch-Eintr√§ge</div>
            <button class="btn secondary" onclick="loadEntries('guest')">Neu laden</button>
          </div>
          <div class="muted" style="margin-top:8px;">Neueste zuerst.</div>
          <div class="hr"></div>
          <div id="list"></div>
        </div>
      </div>
    `;
  }

  function viewFreundebuch(){
    return `
      <div class="grid">
        <div class="card">
          <div class="pill">üìò Freundebuch</div>
          <div class="muted" style="margin-top:6px;">Erwachsen, locker ‚Äì aber pers√∂nlicher.</div>
          <div class="hr"></div>

          <label>Name / Spitzname *</label>
          <input id="name" placeholder="z. B. Tizian" />

          <label>Woher kennen wir uns?</label>
          <input id="kennen" placeholder="z. B. Arbeit, Uni, Freunde..." />

          <label>Wie lange kennen wir uns?</label>
          <select id="dauer">
            <option value="gerade erst">gerade erst</option>
            <option value="< 1 Jahr">&lt; 1 Jahr</option>
            <option value="1‚Äì3 Jahre">1‚Äì3 Jahre</option>
            <option value="3‚Äì5 Jahre">3‚Äì5 Jahre</option>
            <option value="5+ Jahre">5+ Jahre</option>
          </select>

          <label>Drei Worte, die dich beschreiben</label>
          <input id="worte" placeholder="z. B. ruhig, witzig, zuverl√§ssig" />

          <label>Worauf freust du dich in n√§chster Zeit?</label>
          <input id="freu" placeholder="z. B. Urlaub, neues Projekt..." />

          <label>Was ist dir aktuell besonders wichtig?</label>
          <input id="wichtig" placeholder="z. B. Familie, Gesundheit..." />

          <label>Dein aktuelles Lebens-Motto</label>
          <input id="motto" placeholder="z. B. Schritt f√ºr Schritt" />

          <label>Was gibt dir gerade Energie?</label>
          <input id="energie" placeholder="z. B. Sport, Freunde, Musik..." />

          <label>Was sch√§tzt du an mir?</label>
          <textarea id="schaetz" placeholder="Kurz & ehrlich üôÇ"></textarea>

          <label>Eine Erinnerung, die wir teilen</label>
          <textarea id="erinnerung" placeholder="z. B. Reise, Party, Moment..."></textarea>

          <label>Was w√ºrdest du mir w√ºnschen?</label>
          <textarea id="wunsch" placeholder="z. B. Erfolg, Ruhe, Gl√ºck..."></textarea>

          <div class="hr"></div>
          <div class="pill">üéÆ Auswahlspiel (Pflicht)</div>

          <label>D√∂ner oder Pizza? *</label>
          <select id="q1"><option value="">Bitte w√§hlen</option><option>D√∂ner</option><option>Pizza</option></select>

          <label>Bier oder Wein? *</label>
          <select id="q2"><option value="">Bitte w√§hlen</option><option>Bier</option><option>Wein</option></select>

          <label>Netflix oder YouTube? *</label>
          <select id="q3"><option value="">Bitte w√§hlen</option><option>Netflix</option><option>YouTube</option></select>

          <label>Fr√ºhaufsteher oder Nachtmensch? *</label>
          <select id="q4"><option value="">Bitte w√§hlen</option><option>Fr√ºhaufsteher</option><option>Nachtmensch</option></select>

          <label>Spontan oder geplant? *</label>
          <select id="q5"><option value="">Bitte w√§hlen</option><option>Spontan</option><option>Geplant</option></select>

          <div class="hr"></div>
          <label>Lieblingsdrink</label>
          <input id="drink" placeholder="z. B. Espresso Martini, Wasser..." />

          <label>Lieblingsessen</label>
          <input id="essen" placeholder="z. B. Sushi, Pasta..." />

          <label>Emoji, das dich gerade beschreibt</label>
          <input id="emoji" placeholder="z. B. üòé" />

          ${commonInteraktionFields()}
          ${photoField()}

          <button class="saveBtn" id="saveBtn">Eintrag speichern</button>
          <div class="status" id="status"></div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <div class="pill">üìå Freundebuch-Eintr√§ge</div>
            <button class="btn secondary" onclick="loadEntries('friend')">Neu laden</button>
          </div>
          <div class="muted" style="margin-top:8px;">Neueste zuerst.</div>
          <div class="hr"></div>
          <div id="list"></div>
        </div>
      </div>
    `;
  }

  function render(){
    const hash = location.hash || "#/";
    if(hash.startsWith("#/gaestebuch")) appEl.innerHTML = viewGaestebuch();
    else if(hash.startsWith("#/freundebuch")) appEl.innerHTML = viewFreundebuch();
    else appEl.innerHTML = viewHome();

    // Hook save button if present
    const saveBtn = document.getElementById("saveBtn");
    if(saveBtn){
      saveBtn.onclick = async () => {
        const type = (location.hash || "#/").includes("gaestebuch") ? "guest" : "friend";
        await saveEntry(type);
      };
    }

    // Load list if list container exists
    if(document.getElementById("list")){
      const type = (location.hash || "#/").includes("gaestebuch") ? "guest" : "friend";
      loadEntries(type);
    }
  }

  window.addEventListener("hashchange", render);

  // ========= Save =========
  async function saveEntry(type){
    const statusEl = document.getElementById("status");
    const saveBtn = document.getElementById("saveBtn");
    const name = (document.getElementById("name")?.value || "").trim();

    if(!name){
      alert("Name ist Pflicht üôÇ");
      return;
    }

    // Likes/Comments opt-in
    const allowLikes = (document.getElementById("allowLikes")?.value || "yes") === "yes";
    const allowComments = (document.getElementById("allowComments")?.value || "yes") === "yes";

    // Optional image
    const file = document.getElementById("image")?.files?.[0] || null;

    // Pflicht-Auswahlspiel beim Freundebuch
    if(type === "friend"){
      const q1 = document.getElementById("q1").value;
      const q2 = document.getElementById("q2").value;
      const q3 = document.getElementById("q3").value;
      const q4 = document.getElementById("q4").value;
      const q5 = document.getElementById("q5").value;
      if(!q1 || !q2 || !q3 || !q4 || !q5){
        alert("Auswahlspiel ist Pflicht üôÇ Bitte alle 5 ausw√§hlen.");
        return;
      }
    }

    statusEl.textContent = "‚è≥ Speichern‚Ä¶";
    saveBtn.disabled = true;

    let imageUrl = "";
    let storagePath = "";

    try{
      if(file){
        const safe = (file.name || "bild").replace(/\s+/g, "_");
        storagePath = `uploads/${Date.now()}_${safe}`;
        const ref = storage.ref(storagePath);
        await ref.put(file);
        imageUrl = await ref.getDownloadURL();
      }

      const base = {
        type, // "guest" oder "friend"
        name,
        allowLikes,
        allowComments,
        likesCount: 0,
        likedBy: {},
        imageUrl,
        storagePath,
        created: firebase.firestore.FieldValue.serverTimestamp()
      };

      let payload = base;

      if(type === "guest"){
        payload = {
          ...base,
          anlass: (document.getElementById("anlass").value || "").trim(),
          mood: (document.getElementById("mood").value || "").trim(),
          abendWort: (document.getElementById("abendWort").value || "").trim(),
          satz: (document.getElementById("satz").value || "").trim(),
          drink: (document.getElementById("drink").value || "").trim(),
        };
      } else {
        payload = {
          ...base,
          kennen: (document.getElementById("kennen").value || "").trim(),
          dauer: (document.getElementById("dauer").value || "").trim(),
          worte: (document.getElementById("worte").value || "").trim(),
          freu: (document.getElementById("freu").value || "").trim(),
          wichtig: (document.getElementById("wichtig").value || "").trim(),
          motto: (document.getElementById("motto").value || "").trim(),
          energie: (document.getElementById("energie").value || "").trim(),
          schaetz: (document.getElementById("schaetz").value || "").trim(),
          erinnerung: (document.getElementById("erinnerung").value || "").trim(),
          wunsch: (document.getElementById("wunsch").value || "").trim(),
          q1: document.getElementById("q1").value,
          q2: document.getElementById("q2").value,
          q3: document.getElementById("q3").value,
          q4: document.getElementById("q4").value,
          q5: document.getElementById("q5").value,
          drink: (document.getElementById("drink").value || "").trim(),
          essen: (document.getElementById("essen").value || "").trim(),
          emoji: (document.getElementById("emoji").value || "").trim(),
        };
      }

      await db.collection("entries").add(payload);

      statusEl.textContent = "‚úÖ Gespeichert!";
      saveBtn.disabled = false;

      // reset form (soft)
      document.querySelectorAll("input[type=text], input[type=email], textarea").forEach(i => {
        if(i.id !== "adminEmail") i.value = "";
      });
      const img = document.getElementById("image"); if(img) img.value = "";
      ["q1","q2","q3","q4","q5","allowLikes","allowComments"].forEach(id=>{
        const x = document.getElementById(id); if(x && x.tagName==="SELECT") x.selectedIndex = 0;
      });

      loadEntries(type);

    }catch(e){
      console.error(e);
      statusEl.textContent = "‚ùå Fehler: " + (e.message || e);
      saveBtn.disabled = false;
    }
  }

  // ========= Likes + Comments =========
  async function toggleLike(entryId){
    const uid = getLocalUid();
    const ref = db.collection("entries").doc(entryId);

    await db.runTransaction(async (tx) => {
      const snap = await tx.get(ref);
      if(!snap.exists) return;
      const d = snap.data() || {};

      if(!d.allowLikes) return;

      const likedBy = d.likedBy || {};
      let likesCount = Number(d.likesCount || 0);

      if(likedBy[uid]){
        delete likedBy[uid];
        likesCount = Math.max(0, likesCount - 1);
      } else {
        likedBy[uid] = true;
        likesCount = likesCount + 1;
      }
      tx.update(ref, { likedBy, likesCount });
    });
  }

  async function addComment(entryId){
    const nameEl = document.getElementById(`cn_${entryId}`);
    const textEl = document.getElementById(`ct_${entryId}`);
    const name = (nameEl?.value || "").trim() || "Anonym";
    const text = (textEl?.value || "").trim();
    if(!text) return alert("Kommentar ist leer.");

    // check allowComments
    const doc = await db.collection("entries").doc(entryId).get();
    if(!doc.exists) return;
    const d = doc.data();
    if(!d.allowComments) return alert("Kommentare sind bei diesem Eintrag deaktiviert.");

    await db.collection("entries").doc(entryId).collection("comments").add({
      name, text,
      created: firebase.firestore.FieldValue.serverTimestamp()
    });

    textEl.value = "";
    await loadComments(entryId);
  }

  async function loadComments(entryId){
    const box = document.getElementById(`c_${entryId}`);
    if(!box) return;

    const doc = await db.collection("entries").doc(entryId).get();
    if(!doc.exists){ box.innerHTML = ""; return; }
    const d = doc.data();
    if(!d.allowComments){
      box.innerHTML = `<div class="muted">Kommentare deaktiviert.</div>`;
      return;
    }

    const snap = await db.collection("entries").doc(entryId)
      .collection("comments")
      .orderBy("created","asc")
      .limit(50)
      .get();

    if(snap.empty){
      box.innerHTML = `<div class="muted">Noch keine Kommentare.</div>`;
      return;
    }

    box.innerHTML = "";
    snap.forEach(cdoc=>{
      const c = cdoc.data();
      const t = fmtDate(c.created);
      box.innerHTML += `
        <div style="border:1px solid rgba(15,23,42,.12); padding:10px 12px; border-radius:12px; margin-top:8px; background:#fff;">
          <strong>${esc(c.name || "Anonym")}</strong>
          <div style="margin-top:4px">${esc(c.text || "")}</div>
          <div class="muted" style="margin-top:6px; font-size:12px">${esc(t)}</div>
        </div>
      `;
    });
  }

  // ========= Admin delete =========
  async function deleteEntry(entryId){
    if(!isAdmin()){
      alert("Nur Admin darf l√∂schen.");
      return;
    }
    if(!confirm("Eintrag wirklich l√∂schen?")) return;

    const doc = await db.collection("entries").doc(entryId).get();
    if(doc.exists){
      const d = doc.data();
      // delete doc
      await db.collection("entries").doc(entryId).delete();
      // delete image (admin only)
      if(d.storagePath){
        try{ await storage.ref(d.storagePath).delete(); }catch(e){ console.log(e); }
      }
    }
  }

  // ========= Load entries =========
  async function loadEntries(type){
    const list = document.getElementById("list");
    if(!list) return;

    list.innerHTML = `<div class="muted">‚è≥ Lade‚Ä¶</div>`;

    const snap = await db.collection("entries")
      .where("type","==", type)
      .orderBy("created","desc")
      .limit(50)
      .get();

    if(snap.empty){
      list.innerHTML = `<div class="muted">Noch keine Eintr√§ge.</div>`;
      return;
    }

    const uid = getLocalUid();
    const admin = isAdmin();

    list.innerHTML = "";
    for(const doc of snap.docs){
      const d = doc.data();
      const when = fmtDate(d.created);

      const likedBy = d.likedBy || {};
      const alreadyLiked = !!likedBy[uid];
      const likesCount = Number(d.likesCount || 0);

      // Build Q/A blocks depending on type
      let qa = "";
      if(type === "guest"){
        qa = `
          ${d.anlass ? `<div><div class="q">Anlass</div><div class="a">${esc(d.anlass)}</div></div>` : ""}
          ${d.mood ? `<div><div class="q">Stimmung</div><div class="a">${esc(d.mood)}</div></div>` : ""}
          ${d.abendWort ? `<div><div class="q">Abend in einem Wort</div><div class="a">${esc(d.abendWort)}</div></div>` : ""}
          ${d.satz ? `<div><div class="q">Ein Satz an mich</div><div class="a">${esc(d.satz)}</div></div>` : ""}
          ${d.drink ? `<div><div class="q">Lieblingsdrink</div><div class="a">${esc(d.drink)}</div></div>` : ""}
        `;
      } else {
        qa = `
          ${d.kennen ? `<div><div class="q">Woher kennen wir uns?</div><div class="a">${esc(d.kennen)}</div></div>` : ""}
          ${d.dauer ? `<div><div class="q">Wie lange?</div><div class="a">${esc(d.dauer)}</div></div>` : ""}
          ${d.worte ? `<div><div class="q">3 Worte</div><div class="a">${esc(d.worte)}</div></div>` : ""}
          ${d.freu ? `<div><div class="q">Worauf freust du dich?</div><div class="a">${esc(d.freu)}</div></div>` : ""}
          ${d.wichtig ? `<div><div class="q">Was ist wichtig?</div><div class="a">${esc(d.wichtig)}</div></div>` : ""}
          ${d.motto ? `<div><div class="q">Motto</div><div class="a">${esc(d.motto)}</div></div>` : ""}
          ${d.energie ? `<div><div class="q">Energie</div><div class="a">${esc(d.energie)}</div></div>` : ""}
          ${d.schaetz ? `<div><div class="q">Was sch√§tzt du an mir?</div><div class="a">${esc(d.schaetz)}</div></div>` : ""}
          ${d.erinnerung ? `<div><div class="q">Erinnerung</div><div class="a">${esc(d.erinnerung)}</div></div>` : ""}
          ${d.wunsch ? `<div><div class="q">Wunsch</div><div class="a">${esc(d.wunsch)}</div></div>` : ""}
          <div><div class="q">Auswahlspiel</div><div class="a">${esc(d.q1||"")} ‚Ä¢ ${esc(d.q2||"")} ‚Ä¢ ${esc(d.q3||"")} ‚Ä¢ ${esc(d.q4||"")} ‚Ä¢ ${esc(d.q5||"")}</div></div>
          ${d.drink ? `<div><div class="q">Lieblingsdrink</div><div class="a">${esc(d.drink)}</div></div>` : ""}
          ${d.essen ? `<div><div class="q">Lieblingsessen</div><div class="a">${esc(d.essen)}</div></div>` : ""}
          ${d.emoji ? `<div><div class="q">Emoji</div><div class="a">${esc(d.emoji)}</div></div>` : ""}
        `;
      }

      list.innerHTML += `
        <div class="entry">
          <div class="entryHead">
            <div>
              <div class="entryName">${esc(d.name || "")}</div>
              <div class="entryMeta">üïí ${esc(when)}</div>
            </div>
            <div class="pill">${type === "guest" ? "üìï G√§stebuch" : "üìò Freundebuch"}</div>
          </div>

          <div class="entryGrid" style="margin-top:10px;">
            ${d.imageUrl ? `<img class="entryImg" src="${d.imageUrl}" alt="Foto">` : `<div class="muted">Kein Foto</div>`}
            <div class="qa">${qa}</div>
          </div>

          <div class="actions">
            ${d.allowLikes ? `<button class="likeBtn" data-like="${doc.id}">${alreadyLiked ? "‚ù§Ô∏è" : "ü§ç"} Gef√§llt mir (${likesCount})</button>` : `<span class="muted">Likes deaktiviert</span>`}
            ${admin ? `<button class="dangerBtn" data-del="${doc.id}">üóëÔ∏è L√∂schen</button>` : ``}
          </div>

          <div style="margin-top:12px;">
            <div class="pill">üí¨ Kommentare</div>
            <div id="c_${doc.id}" style="margin-top:8px;"></div>

            ${d.allowComments ? `
              <div class="row" style="margin-top:10px;">
                <div>
                  <label>Name</label>
                  <input id="cn_${doc.id}" placeholder="Dein Name" />
                </div>
                <div>
                  <label>Kommentar</label>
                  <input id="ct_${doc.id}" placeholder="Schreib kurz..." />
                </div>
              </div>
              <button class="btn secondary" style="margin-top:10px;" data-addc="${doc.id}">Kommentar posten</button>
            ` : `<div class="muted" style="margin-top:8px;">Kommentare deaktiviert.</div>`}
          </div>
        </div>
      `;
    }

    // Hook buttons
    list.querySelectorAll("[data-like]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-like");
        await toggleLike(id);
        await loadEntries(type);
      });
    });
    list.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-del");
        await deleteEntry(id);
        await loadEntries(type);
      });
    });
    list.querySelectorAll("[data-addc]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-addc");
        await addComment(id);
        await loadComments(id);
      });
    });

    // Load comments for visible entries
    for(const doc of snap.docs){
      await loadComments(doc.id);
    }
  }

  // Start
  if(!location.hash) location.hash = "#/";
  render();
</script>
</body>
</html>